<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Console - Helton Alves</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéöÔ∏è</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&display=swap');

        :root {
            --bg: #050505; --card: #111111; --pad-bg: #1a1a1a;
            --primary: #00e5ff; --accent: #00ff88; --danger: #ff4d4d;
            --text: #f0f0f0; --dim: #999999;
        }

        body.pg-A { --primary: #00e5ff; }
        body.pg-B { --primary: #ffcc00; }
        body.pg-C { --primary: #d600ff; }

        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 10px;
            overflow: auto;
        }

        .container {
            background: var(--card); padding: 12px 25px; border-radius: 12px;
            width: 100%; max-width: 1350px; border: 1px solid #333;
            box-shadow: 0 0 60px rgba(0,0,0,1); display: flex; flex-direction: column; gap: 8px;
            margin: 10px 0;
        }

        .header-main { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 1.7rem; font-weight: 700; letter-spacing: 2px; color: #fff; text-transform: uppercase; }
        .brand span { color: var(--primary); }

        .icon-actions { display: flex; gap: 12px; }
        .action-wrapper { display: flex; flex-direction: column; align-items: center; gap: 3px; width: 55px; }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #222; border: 2px solid #444; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #fff; }
        .icon-btn:hover { border-color: var(--primary); transform: scale(1.05); }
        .icon-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .tooltip-text { font-size: 0.6rem; font-weight: 800; color: var(--dim); text-align: center; }

        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .page-tabs { display: flex; gap: 8px; }
        .tab { background: #1a1a1a; border: 2px solid #333; color: var(--dim); padding: 6px 25px; border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 0.85rem; transition: 0.3s; }
        .tab.active { background: var(--primary); color: #000; border-color: var(--primary); }

        .master-strip { display: grid; grid-template-columns: 1fr 220px; gap: 20px; background: #000; padding: 10px 18px; border-radius: 8px; border: 1px solid #222; align-items: center; }
        .vu-container { height: 10px; background: #111; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        #vu-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00ff88 70%, #ffcc00 85%, #ff3b3b 100%); transition: width 0.07s; }

        .grid-pads { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        .pad { 
            background: var(--pad-bg); height: 115px; border-radius: 10px; 
            border: 2px solid #333; position: relative; cursor: pointer; 
            display: flex; flex-direction: column; padding: 10px 15px; 
            box-sizing: border-box; transition: 0.15s;
        }
        .pad.active { border-color: var(--accent); background: #080808; }

        .prog-bar { 
            position: absolute; top: 0; left: 0; height: 100%; width: 0%; 
            background: rgba(0, 255, 136, 0.1); border-right: 3px solid var(--accent); 
            pointer-events: none; z-index: 1; 
            border-radius: 8px 0 0 8px;
        }

        .p-idx { position: absolute; top: 8px; left: 12px; font-size: 0.9rem; font-weight: 800; color: #444; }
        .pad-controls { position: absolute; top: 6px; right: 10px; display: flex; gap: 8px; z-index: 10; }
        .btn-loop { background: none; border: none; color: #555; cursor: pointer; padding: 4px; display: flex; }
        .btn-loop.active { color: var(--primary); }
        .btn-loop svg { width: 18px; height: 18px; fill: currentColor; }
        .p-menu-trigger { color: var(--dim); font-size: 1.6rem; cursor: pointer; line-height: 0.6; font-weight: bold; }
        
        .p-title { font-size: 1.2rem; font-weight: 800; color: var(--primary); text-align: center; margin-top: 18px; z-index: 2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-footer { margin-top: auto; display: flex; justify-content: space-between; font-size: 0.95rem; font-weight: 600; z-index: 2; }
        
        .console-footer { margin-top: 5px; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.7rem; color: #555; font-weight: 600; }

        .dev-link { color: var(--primary); text-decoration: none; transition: 0.2s; font-weight: 800; border-bottom: 1px solid transparent; }
        .dev-link:hover { border-color: var(--primary); filter: brightness(1.2); }

        #alert { position: fixed; top: 15px; background: var(--primary); color: #000; padding: 10px 30px; border-radius: 8px; font-weight: 800; z-index: 9999; display: none; left: 50%; transform: translateX(-50%); font-size: 0.9rem; }

        .ctx-menu { 
            position: absolute; top: 25px; right: 0; background: #252525; 
            border: 1px solid #555; border-radius: 6px; display: none; 
            flex-direction: column; z-index: 1000; 
            box-shadow: 0 10px 30px #000;
        }
        .ctx-menu.show { display: flex; }
        .ctx-opt { padding: 10px 18px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px solid #333; font-weight: 700; color: #fff; white-space: nowrap; }
        .ctx-opt:hover { background: var(--primary); color: #000; }

        /* ETAPA 1: Controles de volume e fade nos pads */
        .pad-volume-controls {
            position: absolute; bottom: 8px; left: 10px; right: 10px;
            display: flex; align-items: center; gap: 8px; opacity: 0;
            transition: opacity 0.3s; z-index: 3;
        }
        .pad:hover .pad-volume-controls { opacity: 1; }

        .vol-slider { 
            flex-grow: 1; height: 4px; -webkit-appearance: none;
            background: #333; border-radius: 2px; outline: none;
        }
        .vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: var(--primary); border-radius: 50%; cursor: pointer;
        }
        .vol-slider::-moz-range-thumb {
            width: 12px; height: 12px; background: var(--primary);
            border-radius: 50%; cursor: pointer; border: none;
        }

        .fade-control { 
            font-size: 0.65rem; color: var(--dim); font-weight: 600;
            white-space: nowrap; min-width: 40px; text-align: right;
            cursor: pointer; padding: 2px 4px; border-radius: 3px;
        }
        .fade-control:hover { background: rgba(255,255,255,0.1); }

        @media (max-width: 768px) {
            .container { padding: 10px; zoom: 0.95; }
            .grid-pads { grid-template-columns: repeat(2, 1fr); }
            .master-strip { grid-template-columns: 1fr; gap: 10px; }
            .page-tabs { flex-wrap: wrap; }
        }
        @media (max-width: 480px) {
            .grid-pads { grid-template-columns: 1fr; }
            .header-main { flex-direction: column; gap: 10px; }
            .icon-actions { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body class="pg-A">

<div id="alert"></div>

<div class="container">
    <div class="header-main">
        <div class="brand">MASTER<span>CONSOLE</span></div>
        <div class="icon-actions">
            <div class="action-wrapper"><div class="icon-btn" onclick="stopAll()"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4 14H8V8h8v8z"/></svg></div><div class="tooltip-text">STOP [0]</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="saveProject()"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></div><div class="tooltip-text">SALVAR</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="document.getElementById('fileIn').click()"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></div><div class="tooltip-text">ABRIR</div></div>
            <div class="action-wrapper"><div class="icon-btn danger" onclick="confirmWipe()"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div><div class="tooltip-text">LIMPAR</div></div>
            <input type="file" id="fileIn" style="display:none" accept=".json" onchange="loadProject(event)">
        </div>
    </div>

    <div class="top-row">
        <div class="page-tabs">
            <div class="tab active" data-pg="A" onclick="changePage('A')">BANCO A</div>
            <div class="tab" data-pg="B" onclick="changePage('B')">BANCO B</div>
            <div class="tab" data-pg="C" onclick="changePage('C')">BANCO C</div>
        </div>
        <div id="pg-status" style="font-size:0.85rem; font-weight:800; color:var(--primary);">MODO: BANCO A</div>
    </div>

    <div class="master-strip">
        <div class="vu-container"><div id="vu-fill"></div></div>
        <div style="display:flex; align-items:center; gap:12px">
            <span style="font-size:0.75rem; font-weight:800; color:var(--dim)">MASTER</span>
            <input type="range" id="gainSlider" min="0" max="1.5" step="0.01" value="1.0" style="width: 120px; accent-color: var(--primary);">
        </div>
    </div>

    <div class="grid-pads" id="padGrid"></div>

    <div class="console-footer">
        <div>NUMPAD [1-9]: PLAY | [0]: STOP ALL</div>
        <div>
            Desenvolvido por 
            <a href="https://wa.me/5514991540084?text=Ol√°%20Helton,%20estou%20usando%20o%20Master%20Console%20e%20gostaria%20de%20deixar%20uma%20sugest√£o..." 
               target="_blank" class="dev-link">
               Helton Alves | Locutor Publicit√°rio
            </a>
        </div>
    </div>
</div>

<script>
    // Sistema de √Åudio
    let audioCtx, masterGain, analyser;
    let sounds = {}; let activeSources = {}; let currentPage = 'A'; let db; let loops = {};
    let padVolumes = {}; let padFades = {}; let padGainNodes = {}; // ETAPA 1: Novas vari√°veis
    
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 1024;
            masterGain.connect(analyser); 
            analyser.connect(audioCtx.destination);
            masterGain.gain.value = document.getElementById('gainSlider').value;
            updateVU();
        }
        return audioCtx;
    }
    
    // Ativar √°udio no primeiro clique
    document.body.addEventListener('click', function initOnClick() {
        if (!audioCtx || audioCtx.state === 'suspended') {
            initAudio();
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }
        document.body.removeEventListener('click', initOnClick);
    });

    // Criar os 9 pads com controles de volume
    const grid = document.getElementById('padGrid');
    for (let i = 1; i <= 9; i++) {
        const div = document.createElement('div');
        div.className = 'pad'; div.id = `pad-${i}`;
        div.innerHTML = `
            <div class="p-idx">${i}</div>
            <div class="pad-controls">
                <button class="btn-loop" id="loop-${i}" onclick="toggleLoop(event, ${i})">
                    <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                </button>
                <div class="p-menu-trigger" onclick="toggleCtx(event, ${i})">‚ãÆ</div>
                <div class="ctx-menu" id="menu-${i}">
                    <div class="ctx-opt" onclick="clickInput(${i})">üìÅ CARREGAR √ÅUDIO</div>
                    <div class="ctx-opt" onclick="toggleStopGroup(${i})" id="stopgroup-${i}">‚èπÔ∏è GRUPO: OFF</div>
                    <div class="ctx-opt" style="color:#ff4d4d" onclick="clearSlot(${i})">üóëÔ∏è LIMPAR PAD</div>
                </div>
            </div>
            <div class="prog-bar" id="prog-${i}"></div>
            <div class="p-title" id="name-${i}">---</div>
            
            <!-- ETAPA 1: Controles de Volume e Fade -->
            <div class="pad-volume-controls">
                <input type="range" class="vol-slider" id="vol-${i}" min="0" max="1" step="0.01" value="1.0" 
                       oninput="updatePadVolume(${i}, this.value)">
                <div class="fade-control" id="fade-${i}" onclick="cycleFadeSetting(${i})">FADE: OFF</div>
            </div>
            
            <div class="p-footer">
                <span id="cur-${i}">00:00</span>
                <span id="rem-${i}" style="color:#ff4d4d">00:00</span>
            </div>
            <input type="file" id="in-${i}" style="display:none" accept="audio/*" onchange="handleFile(event, ${i})">
        `;
        div.onclick = (e) => { 
            if(!e.target.closest('.pad-controls') && !e.target.closest('.ctx-menu') && !e.target.closest('.pad-volume-controls')) {
                initAudio();
                playSound(i); 
            }
        };
        grid.appendChild(div);
    }

    // Configurar banco de dados
    const dbReq = indexedDB.open("MasterConsoleDB_v3", 2); // Nova vers√£o para suportar settings
    dbReq.onupgradeneeded = function(e) {
        console.log("Criando/atualizando banco de dados v3...");
        db = e.target.result;
        if (!db.objectStoreNames.contains('pads')) {
            const store = db.createObjectStore('pads', { keyPath: 'uid' });
            store.createIndex('page_idx', 'page', { unique: false });
            store.createIndex('type_idx', 'type', { unique: false });
        }
    };
    dbReq.onsuccess = (e) => { 
        db = e.target.result; 
        console.log("Banco de dados v3 pronto.");
        changePage('A'); 
    };
    dbReq.onerror = (e) => { 
        console.error("Erro ao abrir banco de dados:", e.target.error); 
        showAlert("ERRO NO BANCO DE DADOS"); 
    };

    function showAlert(t) {
        const a = document.getElementById('alert'); 
        a.innerText = t; 
        a.style.display = 'block';
        setTimeout(() => a.style.display = 'none', 1200);
    }

    function toggleLoop(e, id) {
        e.stopPropagation();
        const key = currentPage + id;
        loops[key] = !loops[key];
        document.getElementById(`loop-${id}`).classList.toggle('active', loops[key]);
        showAlert(`PAD ${id}: LOOP ${loops[key] ? 'ON' : 'OFF'}`);
    }

    // Buscar dados APENAS da p√°gina atual
    async function changePage(p) {
        // N√ÉO paramos os sons ao mudar de p√°gina (ser√° corrigido na ETAPA 2)
        currentPage = p;
        document.body.className = `pg-${p}`;
        document.getElementById('pg-status').innerText = `MODO: BANCO ${p}`;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.pg === p));
        
        // Resetar visualiza√ß√£o
        for(let i = 1; i <= 9; i++) {
            // S√≥ reseta se n√£o estiver tocando
            if (!activeSources[i] || activeSources[i].page !== currentPage) {
                document.getElementById(`name-${i}`).innerText = "---";
                document.getElementById(`rem-${i}`).innerText = "00:00";
                document.getElementById(`prog-${i}`).style.width = "0%";
                document.getElementById(`cur-${i}`).innerText = "00:00";
            }
            document.getElementById(`loop-${i}`).classList.toggle('active', !!loops[currentPage + i]);
        }

        sounds = {}; // Limpar cache de sons da p√°gina atual
        
        if (db) {
            const tx = db.transaction("pads", "readonly");
            const store = tx.objectStore("pads");
            const index = store.index("page_idx");
            
            // Buscar SOMENTE os registros onde 'page' = p√°gina atual
            const request = index.getAll(currentPage);
            
            request.onsuccess = async (e) => {
                const pageData = e.target.result.filter(item => item.type !== 'settings');
                console.log(`Carregando Banco ${p}:`, pageData.length, "√°udio(s)");
                
                for(let item of pageData) {
                    try {
                        if (!audioCtx) initAudio();
                        const buffer = await audioCtx.decodeAudioData(item.data.slice(0));
                        sounds[item.id] = { 
                            buffer, 
                            name: item.name, 
                            duration: buffer.duration
                        };
                        document.getElementById(`name-${item.id}`).innerText = item.name;
                        document.getElementById(`rem-${item.id}`).innerText = formatTime(buffer.duration);
                    } catch(err) {
                        console.error("Erro ao decodificar √°udio:", err);
                    }
                }
                showAlert(`BANCO ${p} PRONTO`);
                
                // Carregar configura√ß√µes dos pads
                loadPadSettings();
            };
            
            request.onerror = (e) => {
                console.error("Erro ao buscar dados:", e.target.error);
            };
        }
    }

    // ETAPA 1: Volume individual e fade por pad
    function updatePadVolume(padId, volume) {
        const key = `${currentPage}-${padId}`;
        padVolumes[key] = parseFloat(volume);
        
        // Atualizar volume se estiver tocando
        if (padGainNodes[key] && padGainNodes[key].gain) {
            padGainNodes[key].gain.value = volume;
        }
        
        // Salvar no IndexedDB
        savePadSettings(padId);
    }

    function cycleFadeSetting(padId) {
        const key = `${currentPage}-${padId}`;
        const fadeOpts = [
            { name: "OFF", in: 0, out: 0 },
            { name: "IN 1s", in: 1, out: 0 },
            { name: "OUT 1s", in: 0, out: 1 },
            { name: "IN/OUT", in: 0.5, out: 0.5 },
            { name: "IN 2s", in: 2, out: 0 },
            { name: "LONG", in: 1, out: 3 }
        ];
        
        if (!padFades[key]) padFades[key] = { index: 0 };
        padFades[key].index = (padFades[key].index + 1) % fadeOpts.length;
        
        const opt = fadeOpts[padFades[key].index];
        padFades[key].in = opt.in;
        padFades[key].out = opt.out;
        
        document.getElementById(`fade-${padId}`).textContent = `FADE: ${opt.name}`;
        savePadSettings(padId);
    }

    function applyFade(padId, sourceNode, duration) {
        const key = `${currentPage}-${padId}`;
        const volume = padVolumes[key] || 1;
        
        if (!padFades[key]) {
            // Sem fade, apenas volume
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = volume;
            padGainNodes[key] = gainNode;
            sourceNode.connect(gainNode);
            return gainNode;
        }
        
        const now = audioCtx.currentTime;
        const gainNode = audioCtx.createGain();
        
        // Fade in
        if (padFades[key].in > 0) {
            gainNode.gain.setValueAtTime(0.001, now);
            gainNode.gain.exponentialRampToValueAtTime(
                volume, 
                now + Math.min(padFades[key].in, duration * 0.9)
            );
        } else {
            gainNode.gain.value = volume;
        }
        
        // Fade out (se aplic√°vel e se n√£o for loop)
        const loopKey = currentPage + padId;
        if (padFades[key].out > 0 && !loops[loopKey]) {
            const fadeOutStart = now + duration - Math.min(padFades[key].out, duration * 0.9);
            gainNode.gain.setValueAtTime(volume, fadeOutStart);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
        }
        
        padGainNodes[key] = gainNode;
        sourceNode.connect(gainNode);
        return gainNode;
    }

    async function savePadSettings(padId) {
        if (!db) return;
        
        const key = `${currentPage}-${padId}`;
        const settings = {
            uid: `settings-${key}`,
            type: 'settings',
            page: currentPage,
            pad: padId,
            volume: padVolumes[key] || 1,
            fadeIn: padFades[key]?.in || 0,
            fadeOut: padFades[key]?.out || 0,
            fadeIndex: padFades[key]?.index || 0
        };
        
        const tx = db.transaction("pads", "readwrite");
        tx.objectStore("pads").put(settings);
    }

    async function loadPadSettings() {
        if (!db) return;
        
        const tx = db.transaction("pads", "readonly");
        const request = tx.objectStore("pads").getAll();
        
        request.onsuccess = (e) => {
            const allData = e.target.result;
            allData.filter(item => item.type === 'settings').forEach(item => {
                const key = `${item.page}-${item.pad}`;
                padVolumes[key] = item.volume || 1;
                
                if (item.fadeIn > 0 || item.fadeOut > 0 || item.fadeIndex > 0) {
                    padFades[key] = {
                        in: item.fadeIn,
                        out: item.fadeOut,
                        index: item.fadeIndex || 0
                    };
                }
                
                // Atualizar controles visuais se estiver na p√°gina atual
                if (currentPage === item.page) {
                    const volSlider = document.getElementById(`vol-${item.pad}`);
                    if (volSlider) volSlider.value = item.volume || 1;
                    
                    const fadeEl = document.getElementById(`fade-${item.pad}`);
                    if (fadeEl) {
                        const opts = ["OFF", "IN 1s", "OUT 1s", "IN/OUT", "IN 2s", "LONG"];
                        fadeEl.textContent = `FADE: ${opts[item.fadeIndex] || "OFF"}`;
                    }
                }
            });
        };
    }

    function playSound(id) {
        const key = currentPage + id;
        if(!sounds[id]) {
            showAlert(`PAD ${id} VAZIO`);
            return;
        }
        
        if(!audioCtx) initAudio();
        if(audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => playSound(id));
            return;
        }
        
        if(activeSources[id]) { 
            stopSound(id); 
            return; 
        }
        
        try {
            const src = audioCtx.createBufferSource();
            src.buffer = sounds[id].buffer;
            src.loop = !!loops[key];
            
            // Aplicar volume e fade
            const gainNode = applyFade(id, src, sounds[id].duration);
            gainNode.connect(masterGain);
            
            const start = audioCtx.currentTime;
            src.start(0);
            activeSources[id] = { source: src, gain: gainNode, page: currentPage };
            document.getElementById(`pad-${id}`).classList.add('active');
            
            const animate = () => {
                if(!activeSources[id]) return;
                let elapsed = (audioCtx.currentTime - start) % sounds[id].duration;
                document.getElementById(`prog-${id}`).style.width = (elapsed / sounds[id].duration * 100) + "%";
                document.getElementById(`cur-${id}`).innerText = formatTime(elapsed);
                document.getElementById(`rem-${id}`).innerText = "-" + formatTime(sounds[id].duration - elapsed);
                requestAnimationFrame(animate);
            };
            animate();
            
            src.onended = () => { 
                if(!loops[key]) {
                    stopSound(id);
                } else {
                    // Se for loop, n√£o para automaticamente
                    // O loop ser√° controlado pelo toggleLoop
                }
            };
        } catch(err) {
            console.error("Erro ao tocar:", err);
            showAlert("ERRO AO TOCAR");
        }
    }

    function stopSound(id, immediate = false) {
        if(activeSources[id]) { 
            try { 
                const key = `${activeSources[id].page}-${id}`;
                if (!immediate && padFades[key]?.out > 0) {
                    // Fade out suave
                    const now = audioCtx.currentTime;
                    activeSources[id].gain.gain.cancelScheduledValues(now);
                    activeSources[id].gain.gain.setValueAtTime(
                        activeSources[id].gain.gain.value, 
                        now
                    );
                    activeSources[id].gain.gain.exponentialRampToValueAtTime(
                        0.001, 
                        now + padFades[key].out
                    );
                    setTimeout(() => {
                        if (activeSources[id]?.source) {
                            try { activeSources[id].source.stop(); } catch(e) {}
                        }
                    }, padFades[key].out * 1000);
                } else {
                    // Parada imediata
                    activeSources[id].source.stop();
                }
            } catch(e) {} 
            activeSources[id] = null;
        }
        document.getElementById(`pad-${id}`).classList.remove('active');
        document.getElementById(`prog-${id}`).style.width = "0%";
        document.getElementById(`cur-${id}`).innerText = "00:00";
        if (sounds[id]) {
            document.getElementById(`rem-${id}`).innerText = formatTime(sounds[id].duration);
        }
    }

    function stopAll() { 
        Object.keys(activeSources).forEach(id => stopSound(id)); 
    }

    function formatTime(s) {
        const m = Math.floor(s/60); 
        const sc = Math.floor(s%60);
        return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
    }

    window.addEventListener('keydown', (e) => {
        if(e.key >= '1' && e.key <= '9') {
            initAudio();
            playSound(parseInt(e.key));
        }
        if(e.key === '0' || e.key === 'Escape') stopAll();
    });

    // Salvar com UID √∫nico que inclui a p√°gina
    async function handleFile(e, id) {
        const file = e.target.files[0]; 
        if(!file) return;
        
        if(file.size > 10 * 1024 * 1024) {
            showAlert("ARQUIVO MUITO GRANDE (MAX 10MB)");
            return;
        }
        
        try {
            if (!audioCtx) initAudio();
            const raw = await file.arrayBuffer();
            const buffer = await audioCtx.decodeAudioData(raw.slice(0));
            const name = file.name.replace(/\.[^/.]+$/, "").substring(0, 20);
            
            // Criar um ID √∫nico combinando P√ÅGINA + N√öMERO DO PAD
            const uid = `${currentPage}-${id}`;
            sounds[id] = { buffer, name, duration: buffer.duration };
            
            if (db) {
                const tx = db.transaction("pads", "readwrite");
                tx.objectStore("pads").put({ 
                    uid: uid,
                    page: currentPage,
                    id: id,
                    name: name, 
                    data: raw
                });
                showAlert(`PAD ${id} SALVO NO BANCO ${currentPage}`);
            }
            
            document.getElementById(`name-${id}`).innerText = name;
            document.getElementById(`rem-${id}`).innerText = formatTime(buffer.duration);
            e.target.value = '';
        } catch(err) {
            console.error("Erro ao carregar arquivo:", err);
            showAlert("ERRO NO ARQUIVO");
        }
    }

    function clearSlot(id) {
        stopSound(id); 
        delete sounds[id];
        
        if (db) {
            const uid = `${currentPage}-${id}`;
            const tx = db.transaction("pads", "readwrite");
            tx.objectStore("pads").delete(uid);
            
            // Tamb√©m limpar configura√ß√µes
            const settingsUid = `settings-${uid}`;
            tx.objectStore("pads").delete(settingsUid);
        }
        
        document.getElementById(`name-${id}`).innerText = "---";
        document.getElementById(`rem-${id}`).innerText = "00:00";
        document.getElementById(`vol-${id}`).value = 1.0;
        document.getElementById(`fade-${id}`).textContent = "FADE: OFF";
        
        const key = `${currentPage}-${id}`;
        delete padVolumes[key];
        delete padFades[key];
        
        showAlert(`PAD ${id} LIMPO`);
    }

    function confirmWipe() {
        if (confirm("LIMPAR TODA A MEM√ìRIA? Perder√° todos os √°udios em todos os bancos.")) {
            stopAll();
            sounds = {};
            loops = {};
            padVolumes = {};
            padFades = {};
            
            if (db) {
                const tx = db.transaction("pads", "readwrite");
                const store = tx.objectStore("pads");
                store.clear(); 
                tx.oncomplete = () => { 
                    showAlert("MEM√ìRIA COMPLETAMENTE RESETADA"); 
                    changePage(currentPage); 
                };
            }
        }
    }

    function updateVU() {
        if (!analyser) {
            requestAnimationFrame(updateVU);
            return;
        }
        const data = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatTimeDomainData(data);
        let sum = 0; 
        for(let a of data) sum += a*a;
        let rms = Math.sqrt(sum/data.length);
        let level = 0;
        if (rms > 0) {
            level = Math.max(0, Math.min(100, (((20 * Math.log10(rms)) + 48) / 48) * 100));
        }
        document.getElementById('vu-fill').style.width = level + "%";
        requestAnimationFrame(updateVU);
    }

    // Fun√ß√£o SALVAR que funciona no GitHub Pages
    async function saveProject() {
        if (!db) {
            showAlert("BANCO DE DADOS N√ÉO DISPON√çVEL");
            return;
        }
        
        const tx = db.transaction("pads", "readonly");
        const request = tx.objectStore("pads").getAll();
        
        request.onsuccess = (e) => {
            const allData = e.target.result;
            if (allData.length === 0) {
                showAlert("NENHUM √ÅUDIO PARA SALVAR");
                return;
            }
            
            // Converter dados para JSON (bin√°rio para Base64)
            const processed = allData.map(item => {
                if (item.type === 'settings') {
                    // Settings n√£o precisam de data bin√°ria
                    return { 
                        type: 'settings',
                        page: item.page, 
                        pad: item.pad, 
                        volume: item.volume,
                        fadeIn: item.fadeIn,
                        fadeOut: item.fadeOut,
                        fadeIndex: item.fadeIndex
                    };
                } else {
                    const bytes = new Uint8Array(item.data);
                    let binary = '';
                    for (let i = 0; i < bytes.byteLength; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return { 
                        uid: item.uid,
                        page: item.page, 
                        id: item.id, 
                        name: item.name, 
                        data: btoa(binary)
                    };
                }
            });
            
            const jsonData = JSON.stringify(processed, null, 2);
            const blob = new Blob([jsonData], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            // Criar e disparar o link de download
            const a = document.createElement('a');
            a.href = url;
            a.download = `MasterConsole_Backup_${new Date().toISOString().slice(0,10)}.json`;
            
            // Adicionar √† p√°gina, clicar e remover
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Liberar mem√≥ria
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            showAlert(`BACKUP SALVO (${allData.filter(d => d.type !== 'settings').length} √°udio(s))`);
        };
        
        request.onerror = () => {
            showAlert("ERRO AO ACESSAR DADOS PARA SALVAR");
        };
    }

    async function loadProject(e) {
        const file = e.target.files[0]; 
        if(!file) return;
        
        if (!db) {
            showAlert("BANCO DE DADOS N√ÉO DISPON√çVEL");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                const tx = db.transaction("pads", "readwrite");
                const store = tx.objectStore("pads");
                store.clear(); // Limpar banco atual antes de restaurar
                
                for(let item of data) {
                    if (item.type === 'settings') {
                        // Restaurar settings
                        store.put({ 
                            uid: `settings-${item.page}-${item.pad}`,
                            type: 'settings',
                            page: item.page, 
                            pad: item.pad,
                            volume: item.volume,
                            fadeIn: item.fadeIn,
                            fadeOut: item.fadeOut,
                            fadeIndex: item.fadeIndex
                        });
                    } else {
                        // Converter Base64 de volta para bin√°rio
                        const bin = Uint8Array.from(atob(item.data), c => c.charCodeAt(0)).buffer;
                        store.put({ 
                            uid: item.uid,
                            page: item.page, 
                            id: item.id, 
                            name: item.name, 
                            data: bin 
                        });
                    }
                }
                
                tx.oncomplete = () => { 
                    showAlert("PROJETO RESTAURADO!"); 
                    changePage('A'); 
                };
                
                e.target.value = '';
            } catch(err) {
                console.error("Erro ao carregar projeto:", err);
                showAlert("ARQUIVO DE BACKUP INV√ÅLIDO");
            }
        };
        reader.readAsText(file);
    }

    // Fun√ß√µes auxiliares (mantidas do c√≥digo original)
    function clickInput(id) { 
        document.getElementById(`in-${id}`).click(); 
    }
    
    function toggleCtx(e, id) { 
        e.stopPropagation(); 
        document.querySelectorAll('.ctx-menu').forEach(m => {
            if(m.id !== `menu-${id}`) m.classList.remove('show');
        });
        document.getElementById(`menu-${id}`).classList.toggle('show');
    }
    
    function toggleStopGroup(id) {
        // Ser√° implementado na ETAPA 4
        showAlert("GRUPO STOP (Em desenvolvimento na ETAPA 4)");
        document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show'));
    }
    
    window.onclick = () => {
        document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show'));
    };
    
    document.getElementById('gainSlider').oninput = (e) => {
        if(masterGain) masterGain.gain.value = parseFloat(e.target.value);
    };
    
    // Inicializa√ß√£o
    setTimeout(() => {
        if (!audioCtx) initAudio();
    }, 500);
</script>
</body>
</html>

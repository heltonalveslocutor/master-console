<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Console - Helton Alves</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&display=swap');

        :root {
            --bg: #050505; --card: #111111; --pad-bg: #1a1a1a;
            --primary: #00e5ff; --accent: #00ff88; --danger: #ff4d4d;
            --text: #f0f0f0; --dim: #999999;
        }

        body.pg-A { --primary: #00e5ff; }
        body.pg-B { --primary: #ffcc00; }
        body.pg-C { --primary: #d600ff; }

        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; transition: 0.3s ease;
        }

        .container {
            zoom: 1.25; 
            background: var(--card); padding: 12px 25px; border-radius: 12px;
            width: 96vw; max-width: 1350px; border: 1px solid #333;
            box-shadow: 0 0 60px rgba(0,0,0,1); display: flex; flex-direction: column; gap: 8px;
        }

        .header-main { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 1.7rem; font-weight: 700; letter-spacing: 2px; color: #fff; text-transform: uppercase; }
        .brand span { color: var(--primary); }

        .icon-actions { display: flex; gap: 12px; }
        .action-wrapper { display: flex; flex-direction: column; align-items: center; gap: 3px; width: 55px; }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #222; border: 2px solid #444; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #fff; }
        .icon-btn:hover { border-color: var(--primary); transform: scale(1.05); }
        .icon-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .tooltip-text { font-size: 0.6rem; font-weight: 800; color: var(--dim); text-align: center; }

        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .page-tabs { display: flex; gap: 8px; }
        .tab { background: #1a1a1a; border: 2px solid #333; color: var(--dim); padding: 6px 25px; border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 0.85rem; transition: 0.3s; }
        .tab.active { background: var(--primary); color: #000; border-color: var(--primary); }

        .master-strip { display: grid; grid-template-columns: 1fr 220px; gap: 20px; background: #000; padding: 10px 18px; border-radius: 8px; border: 1px solid #222; align-items: center; }
        .vu-container { height: 10px; background: #111; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        #vu-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00ff88 70%, #ffcc00 85%, #ff3b3b 100%); transition: width 0.07s; }

        .grid-pads { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .pad { background: var(--pad-bg); height: 115px; border-radius: 10px; border: 2px solid #333; position: relative; cursor: pointer; display: flex; flex-direction: column; padding: 10px 15px; box-sizing: border-box; transition: 0.15s; }
        .pad.active { border-color: var(--accent); background: #080808; }

        .prog-bar { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: rgba(0, 255, 136, 0.1); border-right: 3px solid var(--accent); pointer-events: none; z-index: 1; border-radius: 8px 0 0 8px; }
        .p-idx { position: absolute; top: 8px; left: 12px; font-size: 0.9rem; font-weight: 800; color: #444; }
        .pad-controls { position: absolute; top: 6px; right: 10px; display: flex; gap: 8px; z-index: 10; }
        .btn-loop { background: none; border: none; color: #555; cursor: pointer; padding: 4px; display: flex; }
        .btn-loop.active { color: var(--primary); }
        .btn-loop svg { width: 18px; height: 18px; fill: currentColor; }
        .p-menu-trigger { color: var(--dim); font-size: 1.6rem; cursor: pointer; line-height: 0.6; font-weight: bold; }
        
        .p-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); text-align: center; margin-top: 22px; z-index: 2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-footer { margin-top: auto; display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; z-index: 2; }
        
        .console-footer { margin-top: 5px; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.7rem; color: #555; font-weight: 600; }
        .dev-link { color: var(--primary); text-decoration: none; transition: 0.2s; font-weight: 800; border-bottom: 1px solid transparent; }

        .ctx-menu { position: absolute; top: 25px; right: 0; background: #252525; border: 1px solid #555; border-radius: 6px; display: none; flex-direction: column; z-index: 1000; box-shadow: 0 10px 30px #000; }
        .ctx-menu.show { display: flex; }
        .ctx-opt { padding: 12px 18px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px solid #333; font-weight: 700; color: #fff; white-space: nowrap; }
        .ctx-opt:hover { background: var(--primary); color: #000; }

        #alert { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 10px 30px; border-radius: 8px; font-weight: 800; z-index: 9999; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="pg-A">

<div id="alert"></div>

<div class="container">
    <div class="header-main">
        <div class="brand">MASTER<span>CONSOLE</span></div>
        <div class="icon-actions">
            <div class="action-wrapper"><div class="icon-btn" onclick="stopAll()"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4 14H8V8h8v8z"/></svg></div><div class="tooltip-text">STOP [0]</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="saveProject()"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></div><div class="tooltip-text">SALVAR</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="document.getElementById('fileIn').click()"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></div><div class="tooltip-text">ABRIR</div></div>
            <div class="action-wrapper"><div class="icon-btn danger" onclick="confirmWipe()"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div><div class="tooltip-text">LIMPAR</div></div>
            <input type="file" id="fileIn" style="display:none" accept=".json" onchange="loadProject(event)">
        </div>
    </div>

    <div class="top-row">
        <div class="page-tabs">
            <div class="tab active" data-pg="A" onclick="changePage('A')">BANCO A</div>
            <div class="tab" data-pg="B" onclick="changePage('B')">BANCO B</div>
            <div class="tab" data-pg="C" onclick="changePage('C')">BANCO C</div>
        </div>
        <div id="pg-status" style="font-size:0.85rem; font-weight:800; color:var(--primary);">MODO: BANCO A</div>
    </div>

    <div class="master-strip">
        <div class="vu-container"><div id="vu-fill"></div></div>
        <div style="display:flex; align-items:center; gap:12px">
            <span style="font-size:0.75rem; font-weight:800; color:var(--dim)">MASTER</span>
            <input type="range" id="gainSlider" min="0" max="1.5" step="0.01" value="1.0" style="width: 120px; accent-color: var(--primary);">
        </div>
    </div>

    <div class="grid-pads" id="padGrid"></div>

    <div class="console-footer">
        <div>NUMPAD [1-9]: PLAY | [0]: STOP ALL</div>
        <div>
            Desenvolvido por 
            <a href="https://wa.me/5514991540084" target="_blank" class="dev-link">Helton Alves | Locutor Publicit√°rio</a>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    masterGain.connect(analyser); analyser.connect(audioCtx.destination);

    let sounds = {}; let activeSources = {}; let currentPage = 'A'; let db; let loops = {};

    const grid = document.getElementById('padGrid');
    for (let i = 1; i <= 9; i++) {
        const div = document.createElement('div');
        div.className = 'pad'; div.id = `pad-${i}`;
        div.innerHTML = `
            <div class="p-idx">${i}</div>
            <div class="pad-controls">
                <button class="btn-loop" id="loop-${i}" onclick="toggleLoop(event, ${i})">
                    <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                </button>
                <div class="p-menu-trigger" onclick="toggleCtx(event, ${i})">‚ãÆ</div>
                <div class="ctx-menu" id="menu-${i}">
                    <div class="ctx-opt" onclick="clickInput(${i})">üìÅ CARREGAR √ÅUDIO</div>
                    <div class="ctx-opt" style="color:#ff4d4d" onclick="clearSlot(${i})">üóëÔ∏è LIMPAR PAD</div>
                </div>
            </div>
            <div class="prog-bar" id="prog-${i}"></div>
            <div class="p-title" id="name-${i}">---</div>
            <div class="p-footer"><span id="cur-${i}">00:00</span><span id="rem-${i}" style="color:#ff4d4d">00:00</span></div>
            <input type="file" id="in-${i}" style="display:none" accept="audio/*" onchange="handleFile(event, ${i})">
        `;
        div.onclick = (e) => { if(!e.target.closest('.pad-controls') && !e.target.closest('.ctx-menu')) playSound(i); };
        grid.appendChild(div);
    }

    const dbReq = indexedDB.open("StudioConsoleDB", 6);
    dbReq.onupgradeneeded = (e) => {
        db = e.target.result;
        if(!db.objectStoreNames.contains("pads")) db.createObjectStore("pads", {keyPath: "uid"});
    };
    dbReq.onsuccess = (e) => { db = e.target.result; changePage('A'); };

    function showAlert(t) {
        const a = document.getElementById('alert'); a.innerText = t; a.style.display = 'block';
        setTimeout(() => a.style.display = 'none', 2000);
    }

    async function changePage(p) {
        stopAll();
        currentPage = p;
        document.body.className = `pg-${p}`;
        document.getElementById('pg-status').innerText = `MODO: BANCO ${p}`;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.pg === p));
        
        // Limpa visual antes de carregar
        for(let i=1; i<=9; i++) {
            document.getElementById(`name-${i}`).innerText = "---";
            document.getElementById(`rem-${i}`).innerText = "00:00";
            document.getElementById(`prog-${i}`).style.width = "0%";
            document.getElementById(`loop-${i}`).classList.remove('active');
        }

        sounds = {};
        const tx = db.transaction("pads", "readonly");
        const store = tx.objectStore("pads");
        store.getAll().onsuccess = async (e) => {
            const pageData = e.target.result.filter(x => x.page === currentPage);
            for(let item of pageData) {
                try {
                    const buffer = await audioCtx.decodeAudioData(item.data.slice(0));
                    sounds[item.id] = { buffer, name: item.name, duration: buffer.duration, raw: item.data };
                    document.getElementById(`name-${item.id}`).innerText = item.name;
                    document.getElementById(`rem-${item.id}`).innerText = formatTime(buffer.duration);
                    if(loops[currentPage + item.id]) document.getElementById(`loop-${item.id}`).classList.add('active');
                } catch(err) { console.error("Erro no pad", item.id); }
            }
        };
    }

    async function handleFile(e, id) {
        const file = e.target.files[0]; if(!file) return;
        const fileName = file.name.replace(/\.[^/.]+$/, ""); // Pega o nome do arquivo aqui!
        const raw = await file.arrayBuffer();
        
        try {
            const buffer = await audioCtx.decodeAudioData(raw.slice(0));
            sounds[id] = { buffer, name: fileName, duration: buffer.duration, raw: raw };
            
            const tx = db.transaction("pads", "readwrite");
            tx.objectStore("pads").put({ uid: currentPage+id, page: currentPage, id, name: fileName, data: raw });
            
            document.getElementById(`name-${id}`).innerText = fileName;
            document.getElementById(`rem-${id}`).innerText = formatTime(buffer.duration);
            showAlert("√ÅUDIO CARREGADO!");
        } catch(err) { showAlert("ERRO NO √ÅUDIO"); }
    }

    function playSound(id) {
        if(!sounds[id]) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        if(activeSources[id]) { stopSound(id); return; }
        
        const src = audioCtx.createBufferSource();
        src.buffer = sounds[id].buffer;
        src.loop = !!loops[currentPage + id];
        src.connect(masterGain);
        const start = audioCtx.currentTime;
        src.start(0); activeSources[id] = src;
        document.getElementById(`pad-${id}`).classList.add('active');
        
        const animate = () => {
            if(!activeSources[id]) return;
            activeSources[id].loop = !!loops[currentPage + id];
            let elapsed = (audioCtx.currentTime - start) % sounds[id].duration;
            document.getElementById(`prog-${id}`).style.width = (elapsed / sounds[id].duration * 100) + "%";
            document.getElementById(`cur-${id}`).innerText = formatTime(elapsed);
            document.getElementById(`rem-${id}`).innerText = "-" + formatTime(sounds[id].duration - elapsed);
            requestAnimationFrame(animate);
        };
        animate();
        src.onended = () => { if(!loops[currentPage + id]) stopSound(id); };
    }

    function stopSound(id) {
        if(activeSources[id]) { try{ activeSources[id].stop(); }catch(e){} activeSources[id] = null; }
        document.getElementById(`pad-${id}`).classList.remove('active');
        document.getElementById(`prog-${id}`).style.width = "0%";
        document.getElementById(`cur-${id}`).innerText = "00:00";
        document.getElementById(`rem-${id}`).innerText = sounds[id] ? formatTime(sounds[id].duration) : "00:00";
    }

    function stopAll() { Object.keys(activeSources).forEach(id => stopSound(id)); }
    function formatTime(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`; }

    function saveProject() {
        const tx = db.transaction("pads", "readonly");
        tx.objectStore("pads").getAll().onsuccess = (e) => {
            const data = e.target.result;
            if(!data.length) return showAlert("BANCO VAZIO!");
            
            const backup = data.map(item => {
                const bytes = new Uint8Array(item.data);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
                return { page: item.page, id: item.id, name: item.name, data: btoa(binary) };
            });

            const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "MASTER_BACKUP.json";
            a.click();
            URL.revokeObjectURL(url);
            showAlert("PALETA SALVA!");
        };
    }

    function loadProject(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const data = JSON.parse(ev.target.result);
            const tx = db.transaction("pads", "readwrite");
            const store = tx.objectStore("pads");
            store.clear();
            data.forEach(item => {
                const bin = Uint8Array.from(atob(item.data), c => c.charCodeAt(0)).buffer;
                store.put({ uid: item.page+item.id, page: item.page, id: item.id, name: item.name, data: bin });
            });
            tx.oncomplete = () => { showAlert("BACKUP CARREGADO!"); changePage('A'); };
        };
        reader.readAsText(file);
    }

    function toggleLoop(e, id) { e.stopPropagation(); loops[currentPage+id] = !loops[currentPage+id]; document.getElementById(`loop-${id}`).classList.toggle('active'); }
    function clearSlot(id) { stopSound(id); delete sounds[id]; const tx = db.transaction("pads", "readwrite"); tx.objectStore("pads").delete(currentPage+id); document.getElementById(`name-${id}`).innerText = "---"; }
    function confirmWipe() { if(confirm("LIMPAR TUDO?")) { const tx = db.transaction("pads", "readwrite"); tx.objectStore("pads").clear(); tx.oncomplete = () => location.reload(); } }
    function clickInput(id) { document.getElementById(`in-${id}`).click(); }
    function toggleCtx(e, id) { e.stopPropagation(); document.querySelectorAll('.ctx-menu').forEach(m => m.id !== `menu-${id}` && m.classList.remove('show')); document.getElementById(`menu-${id}`).classList.toggle('show'); }
    window.onclick = () => document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show'));
    document.getElementById('gainSlider').oninput = (e) => masterGain.gain.value = e.target.value;
    window.addEventListener('keydown', (e) => { if(e.key >= '1' && e.key <= '9') playSound(parseInt(e.key)); if(e.key === '0' || e.key === 'Escape') stopAll(); });
    
    function updateVU() {
        const data = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatTimeDomainData(data);
        let sum = 0; for(let a of data) sum += a*a;
        let level = Math.max(0, Math.min(100, (((20 * Math.log10(Math.sqrt(sum/data.length))) + 48) / 48) * 100));
        document.getElementById('vu-fill').style.width = (level || 0) + "%";
        requestAnimationFrame(updateVU);
    }
    updateVU();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Console - Helton Alves</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéöÔ∏è</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&display=swap');

        :root {
            --bg: #050505; --card: #111111; --pad-bg: #1a1a1a;
            --primary: #00e5ff; --accent: #00ff88; --danger: #ff4d4d;
            --text: #f0f0f0; --dim: #999999;
        }

        body.pg-A { --primary: #00e5ff; }
        body.pg-B { --primary: #ffcc00; }
        body.pg-C { --primary: #d600ff; }

        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 10px;
            overflow: auto;
        }

        .container {
            background: var(--card); padding: 12px 25px; border-radius: 12px;
            width: 100%; max-width: 1350px; border: 1px solid #333;
            box-shadow: 0 0 60px rgba(0,0,0,1); display: flex; flex-direction: column; gap: 8px;
            margin: 10px 0;
        }

        .header-main { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 1.7rem; font-weight: 700; letter-spacing: 2px; color: #fff; text-transform: uppercase; }
        .brand span { color: var(--primary); }

        .icon-actions { display: flex; gap: 12px; }
        .action-wrapper { display: flex; flex-direction: column; align-items: center; gap: 3px; width: 55px; }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #222; border: 2px solid #444; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #fff; }
        .icon-btn:hover { border-color: var(--primary); transform: scale(1.05); }
        .icon-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .tooltip-text { font-size: 0.6rem; font-weight: 800; color: var(--dim); text-align: center; }

        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .page-tabs { display: flex; gap: 8px; }
        .tab { background: #1a1a1a; border: 2px solid #333; color: var(--dim); padding: 6px 25px; border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 0.85rem; transition: 0.3s; }
        .tab.active { background: var(--primary); color: #000; border-color: var(--primary); }

        /* ETAPA 2: Indicador de √°udio ativo */
        .active-audio-indicator {
            display: flex; align-items: center; gap: 10px;
            font-size: 0.85rem; font-weight: 800; color: var(--accent);
            background: rgba(0, 255, 136, 0.1); padding: 6px 12px;
            border-radius: 6px; border: 1px solid rgba(0, 255, 136, 0.3);
            max-width: 250px; overflow: hidden; white-space: nowrap;
            text-overflow: ellipsis;
        }
        .active-audio-indicator:empty { display: none; }
        .active-audio-indicator .playing-icon {
            color: var(--accent); font-size: 1rem; animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .master-strip { display: grid; grid-template-columns: 1fr 220px; gap: 20px; background: #000; padding: 10px 18px; border-radius: 8px; border: 1px solid #222; align-items: center; }
        .vu-container { height: 10px; background: #111; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        #vu-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00ff88 70%, #ffcc00 85%, #ff3b3b 100%); transition: width 0.07s; }

        .grid-pads { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        .pad { 
            background: var(--pad-bg); height: 115px; border-radius: 10px; 
            border: 2px solid #333; position: relative; cursor: pointer; 
            display: flex; flex-direction: column; padding: 10px 15px; 
            box-sizing: border-box; transition: 0.15s;
        }
        .pad.active { border-color: var(--accent); background: #080808; }

        .prog-bar { 
            position: absolute; top: 0; left: 0; height: 100%; width: 0%; 
            background: rgba(0, 255, 136, 0.1); border-right: 3px solid var(--accent); 
            pointer-events: none; z-index: 1; 
            border-radius: 8px 0 0 8px;
        }

        .p-idx { position: absolute; top: 8px; left: 12px; font-size: 0.9rem; font-weight: 800; color: #444; }
        
        /* √ÅREA DE CONTROLES AJUSTADA */
        .pad-controls { 
            position: absolute; top: 6px; right: 10px; 
            display: flex; gap: 10px; /* MAIS ESPA√áO ENTRE ELEMENTOS */
            z-index: 10; 
            align-items: center;
        }
        
        /* VOLUME SLIDER HORIZONTAL com mais margem √† direita */
        .volume-horizontal {
            width: 45px; /* Um pouco mais largo */
            height: 16px;
            display: flex;
            align-items: center;
            margin-right: 4px; /* MAIS ESPA√áO antes do fade */
        }
        
        .vol-horizontal-track {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .vol-horizontal-fill {
            position: absolute;
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            width: 100%;
        }
        
        .vol-horizontal-slider {
            position: absolute;
            top: 50%;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
            z-index: 2;
        }
        
        /* BOT√ïES QUADRADOS ARREDONDADOS - TAMANHOS IGUAIS */
        .btn-square {
            width: 22px;  /* TAMANHO IGUAL PARA AMBOS */
            height: 22px; /* TAMANHO IGUAL PARA AMBOS */
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #444;
            background: rgba(30, 30, 30, 0.7);
        }
        
        /* FADE CONTROL - com estado ativo permanente */
        .fade-control { 
            font-size: 0.8rem; /* Tamanho harmonioso */
            color: var(--dim);
            font-weight: 600;
        }
        .fade-control.has-fade {
            border: 2px solid var(--primary);
            box-shadow: 0 0 6px var(--primary);
            background: rgba(0, 229, 255, 0.1);
            color: var(--primary);
        }
        
        /* LOOP BUTTON - com √≠cone maior */
        .btn-loop { 
            color: #555;
        }
        .btn-loop svg { 
            width: 16px; /* √çCONE MAIOR (era 14px) */
            height: 16px; /* √çCONE MAIOR */
            fill: currentColor;
        }
        .btn-loop.active {
            border: 2px solid var(--primary);
            box-shadow: 0 0 6px var(--primary);
            background: rgba(0, 229, 255, 0.1);
            color: var(--primary);
        }
        
        .btn-square:hover { 
            background: rgba(50, 50, 50, 0.8); 
            border-color: #666;
        }
        
        /* MENU TRIGGER */
        .p-menu-trigger { 
            color: var(--dim); 
            font-size: 1.6rem; 
            cursor: pointer; 
            line-height: 0.6; 
            font-weight: bold;
            margin-left: 2px;
        }
        
        .p-title { 
            font-size: 1.2rem; font-weight: 800; color: var(--primary); 
            text-align: center; margin-top: 18px; z-index: 2; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        .p-footer { 
            margin-top: auto; display: flex; justify-content: space-between; 
            font-size: 0.95rem; font-weight: 600; z-index: 2;
        }
        
        .console-footer { margin-top: 5px; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.7rem; color: #555; font-weight: 600; }

        .dev-link { color: var(--primary); text-decoration: none; transition: 0.2s; font-weight: 800; border-bottom: 1px solid transparent; }
        .dev-link:hover { border-color: var(--primary); filter: brightness(1.2); }

        #alert { position: fixed; top: 15px; background: var(--primary); color: #000; padding: 10px 30px; border-radius: 8px; font-weight: 800; z-index: 9999; display: none; left: 50%; transform: translateX(-50%); font-size: 0.9rem; }

        .ctx-menu { 
            position: absolute; top: 25px; right: 0; background: #252525; 
            border: 1px solid #555; border-radius: 6px; display: none; 
            flex-direction: column; z-index: 1000; 
            box-shadow: 0 10px 30px #000;
        }
        .ctx-menu.show { display: flex; }
        .ctx-opt { padding: 10px 18px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px solid #333; font-weight: 700; color: #fff; white-space: nowrap; }
        .ctx-opt:hover { background: var(--primary); color: #000; }

        /* ETAPA 3: Modal para Stop Groups */
        .stop-group-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .stop-group-modal.active { display: flex; }
        .stop-group-content {
            background: var(--card); padding: 25px; border-radius: 12px;
            border: 1px solid var(--primary); max-width: 450px; width: 90%;
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.2);
        }
        .stop-group-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .stop-group-header h3 {
            color: var(--primary); font-size: 1.2rem; margin: 0;
            font-family: 'Rajdhani', sans-serif;
        }
        .close-modal {
            background: none; border: none; color: var(--dim);
            font-size: 1.5rem; cursor: pointer; line-height: 1;
            padding: 0; width: 30px; height: 30px;
        }
        .stop-group-desc {
            color: var(--dim); font-size: 0.9rem; margin-bottom: 20px;
            line-height: 1.4;
        }
        .stop-group-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            margin-bottom: 25px;
        }
        .stop-group-check {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; background: #1a1a1a; border-radius: 6px;
            border: 1px solid #333; cursor: pointer; transition: 0.2s;
        }
        .stop-group-check:hover { border-color: var(--primary); }
        .stop-group-check input[type="checkbox"] {
            width: 18px; height: 18px; accent-color: var(--primary);
            cursor: pointer;
        }
        .stop-group-check label {
            cursor: pointer; font-weight: 600; font-size: 0.9rem;
            flex: 1;
        }
        .stop-group-actions {
            display: flex; justify-content: flex-end; gap: 10px;
        }
        .stop-group-btn {
            padding: 10px 20px; border-radius: 6px; border: 2px solid;
            font-weight: 800; font-size: 0.85rem; cursor: pointer;
            transition: 0.2s;
        }
        .stop-group-save {
            background: var(--primary); color: #000; border-color: var(--primary);
        }
        .stop-group-save:hover {
            background: #00d4ff; border-color: #00d4ff;
        }
        .stop-group-cancel {
            background: transparent; color: var(--dim); border-color: #444;
        }
        .stop-group-cancel:hover {
            border-color: #666; color: #fff;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; zoom: 0.95; }
            .grid-pads { grid-template-columns: repeat(2, 1fr); }
            .master-strip { grid-template-columns: 1fr; gap: 10px; }
            .page-tabs { flex-wrap: wrap; }
            .pad { padding: 10px 12px; }
            .volume-horizontal { width: 42px; }
            .pad-controls { gap: 8px; }
            .active-audio-indicator { max-width: 200px; font-size: 0.8rem; }
        }
        @media (max-width: 480px) {
            .grid-pads { grid-template-columns: 1fr; }
            .header-main { flex-direction: column; gap: 10px; }
            .icon-actions { width: 100%; justify-content: center; }
            .pad { height: 100px; }
            .p-title { font-size: 1rem; margin-top: 15px; }
            .volume-horizontal { width: 40px; }
            .pad-controls { gap: 6px; }
            .btn-square { width: 20px; height: 20px; }
            .fade-control { font-size: 0.7rem; }
            .btn-loop svg { width: 14px; height: 14px; }
            .active-audio-indicator { max-width: 180px; padding: 4px 8px; }
        }
    </style>
</head>
<body class="pg-A">

<div id="alert"></div>

<!-- ETAPA 3: Modal para Stop Groups -->
<div class="stop-group-modal" id="stopGroupModal">
    <div class="stop-group-content">
        <div class="stop-group-header">
            <h3 id="modalTitle">CONFIGURAR STOP GROUP</h3>
            <button class="close-modal" onclick="closeStopGroupModal()">√ó</button>
        </div>
        <div class="stop-group-desc" id="modalDesc">
            Selecione quais pads ser√£o parados quando este pad tocar.
        </div>
        <div class="stop-group-grid" id="stopGroupGrid">
            <!-- Checkboxes ser√£o gerados dinamicamente -->
        </div>
        <div class="stop-group-actions">
            <button class="stop-group-btn stop-group-cancel" onclick="closeStopGroupModal()">
                CANCELAR
            </button>
            <button class="stop-group-btn stop-group-save" onclick="saveStopGroup()">
                SALVAR
            </button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header-main">
        <div class="brand">MASTER<span>CONSOLE</span></div>
        <div class="icon-actions">
            <div class="action-wrapper"><div class="icon-btn" onclick="stopAll()"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4 14H8V8h8v8z"/></svg></div><div class="tooltip-text">STOP [0]</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="saveProject()"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></div><div class="tooltip-text">SALVAR</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="document.getElementById('fileIn').click()"><svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></div><div class="tooltip-text">ABRIR</div></div>
            <div class="action-wrapper"><div class="icon-btn danger" onclick="confirmWipe()"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div><div class="tooltip-text">LIMPAR</div></div>
            <input type="file" id="fileIn" style="display:none" accept=".json" onchange="loadProject(event)">
        </div>
    </div>

    <div class="top-row">
        <div class="page-tabs">
            <div class="tab active" data-pg="A" onclick="changePage('A')">BANCO A</div>
            <div class="tab" data-pg="B" onclick="changePage('B')">BANCO B</div>
            <div class="tab" data-pg="C" onclick="changePage('C')">BANCO C</div>
        </div>
        
        <!-- ETAPA 2: Indicador de √°udio ativo entre bancos -->
        <div class="active-audio-indicator" id="activeAudioIndicator"></div>
        
        <div id="pg-status" style="font-size:0.85rem; font-weight:800; color:var(--primary);">MODO: BANCO A</div>
    </div>

    <div class="master-strip">
        <div class="vu-container"><div id="vu-fill"></div></div>
        <div style="display:flex; align-items:center; gap:12px">
            <span style="font-size:0.75rem; font-weight:800; color:var(--dim)">MASTER</span>
            <input type="range" id="gainSlider" min="0" max="1.5" step="0.01" value="1.0" style="width: 120px; accent-color: var(--primary);">
        </div>
    </div>

    <div class="grid-pads" id="padGrid"></div>

    <div class="console-footer">
        <div>NUMPAD [1-9]: PLAY | [0]: STOP ALL</div>
        <div>
            Desenvolvido por 
            <a href="https://wa.me/5514991540084?text=Ol√°%20Helton,%20estou%20usando%20o%20Master%20Console%20e%20gostaria%20de%20deixar%20uma%20sugest√£o..." 
               target="_blank" class="dev-link">
               Helton Alves | Locutor Publicit√°rio
            </a>
        </div>
    </div>
</div>

<script>
    // ============================================
    // MASTER CONSOLE - C√ìDIGO REORGANIZADO E CORRIGIDO
    // Vers√£o 4.1 - Com melhorias internas
    // ============================================
    
    // SISTEMA PRINCIPAL
    const MasterConsole = {
        // Audio Context
        audio: {
            ctx: null,
            gain: null,
            analyser: null,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.gain = this.ctx.createGain();
                    this.analyser = this.ctx.createAnalyser();
                    this.analyser.fftSize = 1024;
                    this.gain.connect(this.analyser);
                    this.analyser.connect(this.ctx.destination);
                    this.gain.gain.value = 1.0;
                }
                return this.ctx;
            },
            resume() {
                if (this.ctx && this.ctx.state === 'suspended') {
                    return this.ctx.resume();
                }
                return Promise.resolve();
            }
        },
        
        // Estado atual
        current: {
            page: 'A',
            sounds: {},        // Cache de √°udios do banco atual
            activeSources: {}, // Fontes de √°udio ativas
            padGainNodes: {}   // Nodes de ganho por pad
        },
        
        // Configura√ß√µes persistentes
        settings: {
            volumes: {},      // padVolumes
            fades: {},        // padFades
            loops: {},        // loops
            stopGroups: {}    // stopGroups
        },
        
        // Rastreamento global
        tracking: {
            activeAudios: new Map(), // √Åudios ativos entre bancos
            
            // Adicionar √°udio ativo
            addActive(padId, page, source, duration) {
                const key = `${page}-${padId}`;
                this.activeAudios.set(key, {
                    pad: padId,
                    page: page,
                    playing: true,
                    startTime: MasterConsole.audio.ctx.currentTime,
                    duration: duration,
                    source: source
                });
                this.updateIndicator();
            },
            
            // Remover √°udio ativo
            removeActive(padId, page) {
                const key = `${page}-${padId}`;
                this.activeAudios.delete(key);
                this.updateIndicator();
            },
            
            // Atualizar indicador visual
            updateIndicator() {
                const indicator = document.getElementById('activeAudioIndicator');
                
                if (this.activeAudios.size === 0) {
                    indicator.innerHTML = '';
                    return;
                }
                
                let activeList = [];
                this.activeAudios.forEach((info, key) => {
                    if (info.playing) {
                        activeList.push(`Pad ${info.pad} (Banco ${info.page})`);
                    }
                });
                
                if (activeList.length > 0) {
                    indicator.innerHTML = `<span class="playing-icon">‚ñ∂Ô∏è</span> ${activeList.join(', ')}`;
                } else {
                    indicator.innerHTML = '';
                }
            },
            
            // Parar √°udio de qualquer banco
            stopFromAnywhere(padId, page) {
                const key = `${page}-${padId}`;
                const info = this.activeAudios.get(key);
                
                if (info) {
                    // Se estiver na p√°gina atual
                    if (page === MasterConsole.current.page && MasterConsole.current.activeSources[padId]) {
                        MasterConsole.stopSound(padId, true);
                    } else {
                        // Parar fonte se existir
                        if (info.source) {
                            try { info.source.stop(); } catch(e) {}
                        }
                        this.activeAudios.delete(key);
                        this.updateIndicator();
                    }
                }
            }
        },
        
        // Banco de dados
        db: null,
        initDB() {
            return new Promise((resolve, reject) => {
                const dbReq = indexedDB.open("MasterConsoleDB_v4", 3);
                
                dbReq.onupgradeneeded = (e) => {
                    console.log("Atualizando banco de dados...");
                    this.db = e.target.result;
                    if (!this.db.objectStoreNames.contains('pads')) {
                        const store = this.db.createObjectStore('pads', { keyPath: 'uid' });
                        store.createIndex('page_idx', 'page', { unique: false });
                        store.createIndex('type_idx', 'type', { unique: false });
                    }
                };
                
                dbReq.onsuccess = (e) => { 
                    this.db = e.target.result; 
                    console.log("Banco de dados pronto.");
                    resolve(); 
                };
                
                dbReq.onerror = (e) => { 
                    console.error("Erro no banco:", e.target.error); 
                    reject(e.target.error);
                };
            });
        },
        
        // ===== FUN√á√ïES PRINCIPAIS =====
        
        // Inicializar sistema de √°udio
        initAudio() {
            return this.audio.init();
        },
        
        // Mudar p√°gina/banco
        async changePage(page) {
            this.current.page = page;
            
            // Atualizar UI
            document.body.className = `pg-${page}`;
            document.getElementById('pg-status').innerText = `MODO: BANCO ${page}`;
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.pg === page);
            });
            
            // Atualizar indicador
            this.tracking.updateIndicator();
            
            // Limpar cache do banco anterior
            this.current.sounds = {};
            this.current.activeSources = {};
            this.current.padGainNodes = {};
            
            // Resetar visualiza√ß√£o dos pads n√£o ativos
            for(let i = 1; i <= 9; i++) {
                const isPlayingElsewhere = Array.from(this.tracking.activeAudios.keys()).some(key => {
                    const info = this.tracking.activeAudios.get(key);
                    return info.pad === i && info.playing;
                });
                
                if (!isPlayingElsewhere) {
                    document.getElementById(`name-${i}`).innerText = "---";
                    document.getElementById(`rem-${i}`).innerText = "00:00";
                    document.getElementById(`prog-${i}`).style.width = "0%";
                    document.getElementById(`cur-${i}`).innerText = "00:00";
                }
            }
            
            // Carregar dados do banco
            await this.loadBankData(page);
            await this.loadPadSettings();
            this.updateStopGroupMenuLabels();
            
            showAlert(`BANCO ${page} PRONTO`);
        },
        
        // Carregar dados do banco
        async loadBankData(page) {
            if (!this.db) return;
            
            return new Promise((resolve) => {
                const tx = this.db.transaction("pads", "readonly");
                const store = tx.objectStore("pads");
                const index = store.index("page_idx");
                
                const request = index.getAll(page);
                
                request.onsuccess = async (e) => {
                    const pageData = e.target.result.filter(item => item.type !== 'settings' && item.type !== 'stopgroup');
                    
                    for(let item of pageData) {
                        try {
                            if (!this.audio.ctx) this.initAudio();
                            const buffer = await this.audio.ctx.decodeAudioData(item.data.slice(0));
                            this.current.sounds[item.id] = {
                                buffer,
                                name: item.name,
                                duration: buffer.duration
                            };
                            document.getElementById(`name-${item.id}`).innerText = item.name;
                            document.getElementById(`rem-${item.id}`).innerText = this.formatTime(buffer.duration);
                        } catch(err) {
                            console.error("Erro ao decodificar √°udio:", err);
                        }
                    }
                    resolve();
                };
            });
        },
        
        // Tocar som
        playSound(padId) {
            // ETAPA 3: Aplicar stop groups
            this.applyStopGroups(padId);
            
            const key = this.current.page + padId;
            if (!this.current.sounds[padId]) {
                showAlert(`PAD ${padId} VAZIO`);
                return;
            }
            
            if (!this.audio.ctx) this.initAudio();
            if (this.audio.ctx.state === 'suspended') {
                this.audio.resume().then(() => this.playSound(padId));
                return;
            }
            
            if (this.current.activeSources[padId]) {
                this.stopSound(padId);
                return;
            }
            
            try {
                const src = this.audio.ctx.createBufferSource();
                src.buffer = this.current.sounds[padId].buffer;
                src.loop = !!this.settings.loops[key];
                
                // Aplicar fade e volume
                const gainNode = this.applyFade(padId, src, this.current.sounds[padId].duration);
                gainNode.connect(this.audio.gain);
                
                const start = this.audio.ctx.currentTime;
                src.start(0);
                
                this.current.activeSources[padId] = {
                    source: src,
                    gain: gainNode,
                    page: this.current.page
                };
                
                // Registrar como ativo
                this.tracking.addActive(padId, this.current.page, src, this.current.sounds[padId].duration);
                
                document.getElementById(`pad-${padId}`).classList.add('active');
                
                // Animar progresso
                this.animateProgress(padId, start);
                
                src.onended = () => {
                    if (!this.settings.loops[key]) {
                        this.stopSound(padId);
                    }
                };
                
            } catch(err) {
                console.error("Erro ao tocar:", err);
                showAlert("ERRO AO TOCAR");
            }
        },
        
        // ETAPA 3: Aplicar stop groups
        applyStopGroups(padId) {
            const key = `${this.current.page}-${padId}`;
            if (this.settings.stopGroups[key]) {
                this.settings.stopGroups[key].forEach(target => {
                    const [targetPage, targetId] = target.split('-');
                    this.tracking.stopFromAnywhere(targetId, targetPage);
                });
            }
        },
        
        // Parar som
        stopSound(padId, immediate = false) {
            const audioKey = `${this.current.page}-${padId}`;
            const source = this.current.activeSources[padId];
            
            if (source) {
                try {
                    const settingsKey = `${source.page}-${padId}`;
                    const fadeOut = this.settings.fades[settingsKey]?.out || 0;
                    
                    if (!immediate && fadeOut > 0) {
                        // Fade out suave
                        const now = this.audio.ctx.currentTime;
                        source.gain.gain.cancelScheduledValues(now);
                        source.gain.gain.setValueAtTime(source.gain.gain.value, now);
                        source.gain.gain.exponentialRampToValueAtTime(0.001, now + fadeOut);
                        
                        setTimeout(() => {
                            if (source.source) {
                                try { source.source.stop(); } catch(e) {}
                            }
                            this.cleanupPad(padId, audioKey);
                        }, fadeOut * 1000);
                    } else {
                        // Parada imediata
                        source.source.stop();
                        this.cleanupPad(padId, audioKey);
                    }
                } catch(e) {
                    this.cleanupPad(padId, audioKey);
                }
            } else {
                this.cleanupPad(padId, audioKey);
            }
        },
        
        // Limpar pad ap√≥s parar
        cleanupPad(padId, audioKey) {
            this.current.activeSources[padId] = null;
            this.tracking.removeActive(padId, this.current.page);
            
            document.getElementById(`pad-${padId}`).classList.remove('active');
            document.getElementById(`prog-${padId}`).style.width = "0%";
            document.getElementById(`cur-${padId}`).innerText = "00:00";
            
            if (this.current.sounds[padId]) {
                document.getElementById(`rem-${padId}`).innerText = 
                    this.formatTime(this.current.sounds[padId].duration);
            }
        },
        
        // Parar todos os sons
        stopAll() {
            this.tracking.activeAudios.clear();
            this.tracking.updateIndicator();
            
            Object.keys(this.current.activeSources).forEach(id => {
                if (this.current.activeSources[id]) {
                    this.stopSound(id, true);
                }
            });
        },
        
        // Aplicar fade
        applyFade(padId, sourceNode, duration) {
            const key = `${this.current.page}-${padId}`;
            const volume = this.settings.volumes[key] || 1;
            const fade = this.settings.fades[key] || { in: 0, out: 0 };
            
            const gainNode = this.audio.ctx.createGain();
            const now = this.audio.ctx.currentTime;
            
            // Fade in
            if (fade.in > 0) {
                gainNode.gain.setValueAtTime(0.001, now);
                gainNode.gain.exponentialRampToValueAtTime(
                    volume, 
                    now + Math.min(fade.in, duration * 0.9)
                );
            } else {
                gainNode.gain.value = volume;
            }
            
            // Fade out (se n√£o for loop)
            const loopKey = this.current.page + padId;
            if (fade.out > 0 && !this.settings.loops[loopKey]) {
                const fadeOutStart = now + duration - Math.min(fade.out, duration * 0.9);
                gainNode.gain.setValueAtTime(volume, fadeOutStart);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
            }
            
            this.current.padGainNodes[key] = gainNode;
            sourceNode.connect(gainNode);
            return gainNode;
        },
        
        // Animar barra de progresso
        animateProgress(padId, startTime) {
            const animate = () => {
                const source = this.current.activeSources[padId];
                if (!source || !this.current.sounds[padId]) return;
                
                let elapsed = (this.audio.ctx.currentTime - startTime) % this.current.sounds[padId].duration;
                document.getElementById(`prog-${padId}`).style.width = 
                    (elapsed / this.current.sounds[padId].duration * 100) + "%";
                document.getElementById(`cur-${padId}`).innerText = this.formatTime(elapsed);
                document.getElementById(`rem-${padId}`).innerText = 
                    "-" + this.formatTime(this.current.sounds[padId].duration - elapsed);
                
                requestAnimationFrame(animate);
            };
            animate();
        },
        
        // ===== FUN√á√ïES AUXILIARES =====
        
        formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        },
        
        updatePadVolume(padId, volume) {
            const key = `${this.current.page}-${padId}`;
            this.settings.volumes[key] = parseFloat(volume);
            
            // Atualizar visual
            const slider = document.getElementById(`vol-slider-${padId}`);
            const fill = document.getElementById(`vol-fill-${padId}`);
            if (slider && fill) {
                const percent = volume * 100;
                slider.style.left = `${percent}%`;
                fill.style.width = `${percent}%`;
            }
            
            // Atualizar √°udio se estiver tocando
            if (this.current.padGainNodes[key]) {
                this.current.padGainNodes[key].gain.value = volume;
            }
            
            this.savePadSettings(padId);
        },
        
        cycleFadeSetting(padId) {
            const key = `${this.current.page}-${padId}`;
            const fadeOpts = [
                { symbol: "‚Äì", title: "Sem Fade", in: 0, out: 0 },
                { symbol: "‚Üó", title: "Fade In 1s", in: 1, out: 0 },
                { symbol: "‚Üò", title: "Fade Out 1s", in: 0, out: 1 },
                { symbol: "‚Üó‚Üò", title: "Fade In/Out 0.5s", in: 0.5, out: 0.5 },
                { symbol: "‚Üó2", title: "Fade In 2s", in: 2, out: 0 },
                { symbol: "‚è±Ô∏è", title: "Fade In 1s / Out 3s", in: 1, out: 3 }
            ];
            
            if (!this.settings.fades[key]) {
                this.settings.fades[key] = { index: 0, ...fadeOpts[0] };
            }
            
            this.settings.fades[key].index = (this.settings.fades[key].index + 1) % fadeOpts.length;
            const opt = fadeOpts[this.settings.fades[key].index];
            
            this.settings.fades[key].in = opt.in;
            this.settings.fades[key].out = opt.out;
            
            const fadeEl = document.getElementById(`fade-${padId}`);
            fadeEl.textContent = opt.symbol;
            fadeEl.title = opt.title;
            
            if (this.settings.fades[key].index === 0) {
                fadeEl.classList.remove('has-fade');
                fadeEl.style.color = '';
            } else {
                fadeEl.classList.add('has-fade');
                fadeEl.style.color = 'var(--primary)';
            }
            
            fadeEl.style.transform = 'scale(1.1)';
            setTimeout(() => fadeEl.style.transform = '', 150);
            
            this.savePadSettings(padId);
        },
        
        toggleLoop(padId) {
            const key = this.current.page + padId;
            this.settings.loops[key] = !this.settings.loops[key];
            
            const loopBtn = document.getElementById(`loop-${padId}`);
            loopBtn.classList.toggle('active', this.settings.loops[key]);
            
            showAlert(`PAD ${padId}: LOOP ${this.settings.loops[key] ? 'ON' : 'OFF'}`);
            this.savePadSettings(padId);
        },
        
        // ===== PERSIST√äNCIA =====
        
        async savePadSettings(padId) {
            if (!this.db) return;
            
            const key = `${this.current.page}-${padId}`;
            const settings = {
                uid: `settings-${key}`,
                type: 'settings',
                page: this.current.page,
                pad: padId,
                volume: this.settings.volumes[key] || 1,
                fadeIn: this.settings.fades[key]?.in || 0,
                fadeOut: this.settings.fades[key]?.out || 0,
                fadeIndex: this.settings.fades[key]?.index || 0,
                loop: this.settings.loops[key] || false
            };
            
            const tx = this.db.transaction("pads", "readwrite");
            tx.objectStore("pads").put(settings);
        },
        
        async loadPadSettings() {
            if (!this.db) return;
            
            return new Promise((resolve) => {
                const tx = this.db.transaction("pads", "readonly");
                const request = tx.objectStore("pads").getAll();
                
                request.onsuccess = (e) => {
                    const allData = e.target.result;
                    
                    allData.filter(item => item.type === 'settings').forEach(item => {
                        const key = `${item.page}-${item.pad}`;
                        
                        this.settings.volumes[key] = item.volume || 1;
                        
                        if (item.fadeIn > 0 || item.fadeOut > 0 || item.fadeIndex > 0) {
                            this.settings.fades[key] = {
                                in: item.fadeIn,
                                out: item.fadeOut,
                                index: item.fadeIndex || 0
                            };
                        }
                        
                        if (item.loop !== undefined) {
                            this.settings.loops[key] = item.loop;
                        }
                        
                        // Atualizar controles se for o banco atual
                        if (this.current.page === item.page) {
                            this.updatePadControls(item.pad);
                        }
                    });
                    
                    resolve();
                };
            });
        },
        
        updatePadControls(padId) {
            const key = `${this.current.page}-${padId}`;
            
            // Volume
            const slider = document.getElementById(`vol-slider-${padId}`);
            const fill = document.getElementById(`vol-fill-${padId}`);
            if (slider && fill) {
                const volume = this.settings.volumes[key] || 1;
                const percent = volume * 100;
                slider.style.left = `${percent}%`;
                fill.style.width = `${percent}%`;
            }
            
            // Fade
            const fadeEl = document.getElementById(`fade-${padId}`);
            if (fadeEl) {
                const symbols = ["‚Äì", "‚Üó", "‚Üò", "‚Üó‚Üò", "‚Üó2", "‚è±Ô∏è"];
                const titles = [
                    "Sem Fade", "Fade In 1s", "Fade Out 1s", 
                    "Fade In/Out 0.5s", "Fade In 2s", "Fade In 1s / Out 3s"
                ];
                
                const fade = this.settings.fades[key];
                const idx = fade?.index || 0;
                fadeEl.textContent = symbols[idx] || "‚Äì";
                fadeEl.title = titles[idx] || "Sem Fade";
                
                if (idx === 0) {
                    fadeEl.classList.remove('has-fade');
                    fadeEl.style.color = '';
                } else {
                    fadeEl.classList.add('has-fade');
                    fadeEl.style.color = 'var(--primary)';
                }
            }
            
            // Loop
            const loopBtn = document.getElementById(`loop-${padId}`);
            if (loopBtn) {
                loopBtn.classList.toggle('active', !!this.settings.loops[key]);
            }
        },
        
        // ===== STOP GROUPS =====
        
        async loadStopGroups() {
            if (!this.db) return;
            
            return new Promise((resolve) => {
                const tx = this.db.transaction("pads", "readonly");
                const request = tx.objectStore("pads").getAll();
                
                request.onsuccess = (e) => {
                    const allData = e.target.result;
                    allData.filter(item => item.type === 'stopgroup').forEach(item => {
                        const key = `${item.page}-${item.pad}`;
                        this.settings.stopGroups[key] = item.targets || [];
                    });
                    
                    this.updateStopGroupMenuLabels();
                    resolve();
                };
            });
        },
        
        updateStopGroupMenuLabels() {
            for (let i = 1; i <= 9; i++) {
                const key = `${this.current.page}-${i}`;
                const menuItem = document.getElementById(`stopgroup-opt-${i}`);
                if (menuItem) {
                    const targets = this.settings.stopGroups[key];
                    if (targets && targets.length > 0) {
                        const targetList = targets.map(t => t.split('-')[1]).join(',');
                        menuItem.textContent = `‚èπÔ∏è GRUPO STOP: ${targetList}`;
                    } else {
                        menuItem.textContent = '‚èπÔ∏è GRUPO STOP: NENHUM';
                    }
                }
            }
        }
    };

    // ============================================
    // INICIALIZA√á√ÉO DA P√ÅGINA
    // ============================================

    // Elemento para alertas
    function showAlert(text) {
        const alert = document.getElementById('alert');
        alert.textContent = text;
        alert.style.display = 'block';
        setTimeout(() => alert.style.display = 'none', 1200);
    }

    // Criar os 9 pads
    function createPads() {
        const grid = document.getElementById('padGrid');
        
        for (let i = 1; i <= 9; i++) {
            const pad = document.createElement('div');
            pad.className = 'pad';
            pad.id = `pad-${i}`;
            pad.innerHTML = `
                <div class="p-idx">${i}</div>
                
                <div class="pad-controls">
                    <div class="volume-horizontal" id="vol-container-${i}">
                        <div class="vol-horizontal-track" id="vol-track-${i}">
                            <div class="vol-horizontal-fill" id="vol-fill-${i}"></div>
                            <div class="vol-horizontal-slider" id="vol-slider-${i}"></div>
                        </div>
                    </div>
                    
                    <div class="btn-square fade-control" id="fade-${i}" onclick="cycleFade(${i})" title="Clique para alternar Fade">‚Äì</div>
                    
                    <button class="btn-square btn-loop" id="loop-${i}" onclick="toggleLoopBtn(${i})" title="Loop ON/OFF">
                        <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    </button>
                    
                    <div class="p-menu-trigger" onclick="toggleMenu(event, ${i})">‚ãÆ</div>
                    
                    <div class="ctx-menu" id="menu-${i}">
                        <div class="ctx-opt" onclick="clickInput(${i})">üìÅ CARREGAR √ÅUDIO</div>
                        <div class="ctx-opt" onclick="openStopGroupModal(${i})" id="stopgroup-opt-${i}">‚èπÔ∏è GRUPO STOP: NENHUM</div>
                        <div class="ctx-opt" style="color:#ff4d4d" onclick="clearSlot(${i})">üóëÔ∏è LIMPAR PAD</div>
                    </div>
                </div>
                
                <div class="prog-bar" id="prog-${i}"></div>
                <div class="p-title" id="name-${i}">---</div>
                
                <div class="p-footer">
                    <span id="cur-${i}">00:00</span>
                    <span id="rem-${i}" style="color:#ff4d4d">00:00</span>
                </div>
                <input type="file" id="in-${i}" style="display:none" accept="audio/*" onchange="handleFile(event, ${i})">
            `;
            
            // Configurar slider de volume
            setupVolumeSlider(i);
            
            // Configurar clique no pad
            pad.onclick = (e) => {
                if (!e.target.closest('.pad-controls') && !e.target.closest('.ctx-menu')) {
                    MasterConsole.initAudio();
                    MasterConsole.playSound(i);
                }
            };
            
            grid.appendChild(pad);
        }
    }

    // Configurar slider de volume
    function setupVolumeSlider(padId) {
        const track = document.getElementById(`vol-track-${padId}`);
        const slider = document.getElementById(`vol-slider-${padId}`);
        const fill = document.getElementById(`vol-fill-${padId}`);
        
        if (!track || !slider || !fill) return;
        
        let isDragging = false;
        
        const updateVolume = (clientX) => {
            const rect = track.getBoundingClientRect();
            let x = clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            
            const volume = x / rect.width;
            MasterConsole.updatePadVolume(padId, volume);
            
            const percent = volume * 100;
            slider.style.left = `${percent}%`;
            fill.style.width = `${percent}%`;
        };
        
        // Mouse events
        slider.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            isDragging = true;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
        
        track.addEventListener('click', (e) => {
            e.stopPropagation();
            updateVolume(e.clientX);
        });
        
        const onMouseMove = (e) => {
            if (!isDragging) return;
            updateVolume(e.clientX);
        };
        
        const onMouseUp = () => {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        // Touch events
        slider.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            isDragging = true;
            document.addEventListener('touchmove', onTouchMove);
            document.addEventListener('touchend', onTouchEnd);
        });
        
        track.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            if (e.touches[0]) {
                updateVolume(e.touches[0].clientX);
            }
        });
        
        const onTouchMove = (e) => {
            if (!isDragging || !e.touches[0]) return;
            updateVolume(e.touches[0].clientX);
        };
        
        const onTouchEnd = () => {
            isDragging = false;
            document.removeEventListener('touchmove', onTouchMove);
            document.removeEventListener('touchend', onTouchEnd);
        };
    }

    // ============================================
    // FUN√á√ïES GLOBAIS (interface com o HTML)
    // ============================================

    // Inicializa√ß√£o
    async function initApp() {
        // Criar pads
        createPads();
        
        // Inicializar banco de dados
        try {
            await MasterConsole.initDB();
            await MasterConsole.changePage('A');
            await MasterConsole.loadStopGroups();
        } catch (error) {
            console.error("Erro na inicializa√ß√£o:", error);
            showAlert("ERRO NA INICIALIZA√á√ÉO");
        }
        
        // Configurar eventos globais
        setupGlobalEvents();
        
        // Inicializar √°udio no primeiro clique
        document.body.addEventListener('click', function initAudioOnClick() {
            MasterConsole.initAudio();
            document.body.removeEventListener('click', initAudioOnClick);
        }, { once: true });
    }

    function setupGlobalEvents() {
        // Teclado
        window.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '9') {
                MasterConsole.initAudio();
                MasterConsole.playSound(parseInt(e.key));
            }
            if (e.key === '0' || e.key === 'Escape') {
                MasterConsole.stopAll();
            }
        });
        
        // Master volume
        document.getElementById('gainSlider').oninput = (e) => {
            if (MasterConsole.audio.gain) {
                MasterConsole.audio.gain.gain.value = parseFloat(e.target.value);
            }
        };
        
        // Fechar menus ao clicar fora
        window.onclick = () => {
            document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show'));
        };
    }

    // Fun√ß√µes chamadas pelo HTML
    function changePage(page) {
        MasterConsole.changePage(page);
    }
    
    function playSound(id) {
        MasterConsole.playSound(id);
    }
    
    function stopSound(id) {
        MasterConsole.stopSound(id);
    }
    
    function stopAll() {
        MasterConsole.stopAll();
    }
    
    function toggleLoopBtn(id) {
        MasterConsole.toggleLoop(id);
    }
    
    function cycleFade(id) {
        MasterConsole.cycleFadeSetting(id);
    }
    
    function updatePadVolume(id, volume) {
        MasterConsole.updatePadVolume(id, volume);
    }

    // ============================================
    // FUN√á√ïES DE ARQUIVO E PROJETO
    // ============================================

    async function handleFile(e, id) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
            showAlert("ARQUIVO MUITO GRANDE (MAX 10MB)");
            return;
        }
        
        try {
            const raw = await file.arrayBuffer();
            
            // Decodificar √°udio
            if (!MasterConsole.audio.ctx) MasterConsole.initAudio();
            const buffer = await MasterConsole.audio.ctx.decodeAudioData(raw.slice(0));
            
            const name = file.name.replace(/\.[^/.]+$/, "").substring(0, 20);
            const uid = `${MasterConsole.current.page}-${id}`;
            
            // Salvar no cache
            MasterConsole.current.sounds[id] = {
                buffer,
                name,
                duration: buffer.duration
            };
            
            // Salvar no IndexedDB
            if (MasterConsole.db) {
                const tx = MasterConsole.db.transaction("pads", "readwrite");
                tx.objectStore("pads").put({
                    uid: uid,
                    page: MasterConsole.current.page,
                    id: id,
                    name: name,
                    data: raw
                });
            }
            
            // Atualizar UI
            document.getElementById(`name-${id}`).innerText = name;
            document.getElementById(`rem-${id}`).innerText = MasterConsole.formatTime(buffer.duration);
            
            showAlert(`PAD ${id} SALVO NO BANCO ${MasterConsole.current.page}`);
            e.target.value = '';
            
        } catch(err) {
            console.error("Erro ao carregar arquivo:", err);
            showAlert("ERRO NO ARQUIVO");
        }
    }

    function clearSlot(id) {
        MasterConsole.stopSound(id);
        delete MasterConsole.current.sounds[id];
        
        if (MasterConsole.db) {
            const uid = `${MasterConsole.current.page}-${id}`;
            const tx = MasterConsole.db.transaction("pads", "readwrite");
            
            // Remover √°udio
            tx.objectStore("pads").delete(uid);
            
            // Remover configura√ß√µes
            tx.objectStore("pads").delete(`settings-${uid}`);
            
            // Remover stop group
            tx.objectStore("pads").delete(`stopgroup-${uid}`);
            
            // Remover do cache
            delete MasterConsole.settings.stopGroups[uid];
        }
        
        // Resetar UI
        document.getElementById(`name-${id}`).innerText = "---";
        document.getElementById(`rem-${id}`).innerText = "00:00";
        
        const slider = document.getElementById(`vol-slider-${id}`);
        const fill = document.getElementById(`vol-fill-${id}`);
        if (slider && fill) {
            slider.style.left = "100%";
            fill.style.width = "100%";
        }
        
        const fadeEl = document.getElementById(`fade-${id}`);
        if (fadeEl) {
            fadeEl.textContent = "‚Äì";
            fadeEl.title = "Sem Fade";
            fadeEl.classList.remove('has-fade');
            fadeEl.style.color = '';
        }
        
        const loopBtn = document.getElementById(`loop-${id}`);
        if (loopBtn) {
            loopBtn.classList.remove('active');
        }
        
        const key = `${MasterConsole.current.page}-${id}`;
        delete MasterConsole.settings.volumes[key];
        delete MasterConsole.settings.fades[key];
        delete MasterConsole.settings.loops[key];
        
        MasterConsole.updateStopGroupMenuLabels();
        showAlert(`PAD ${id} LIMPO`);
    }

    function confirmWipe() {
        if (confirm("LIMPAR TODA A MEM√ìRIA? Perder√° todos os √°udios em todos os bancos.")) {
            MasterConsole.stopAll();
            
            // Limpar caches
            MasterConsole.current.sounds = {};
            MasterConsole.settings = {
                volumes: {},
                fades: {},
                loops: {},
                stopGroups: {}
            };
            MasterConsole.tracking.activeAudios.clear();
            
            // Limpar banco de dados
            if (MasterConsole.db) {
                const tx = MasterConsole.db.transaction("pads", "readwrite");
                tx.objectStore("pads").clear();
                tx.oncomplete = () => {
                    showAlert("MEM√ìRIA COMPLETAMENTE RESETADA");
                    MasterConsole.changePage(MasterConsole.current.page);
                };
            }
        }
    }

    async function saveProject() {
        if (!MasterConsole.db) {
            showAlert("BANCO DE DADOS N√ÉO DISPON√çVEL");
            return;
        }
        
        const tx = MasterConsole.db.transaction("pads", "readonly");
        const request = tx.objectStore("pads").getAll();
        
        request.onsuccess = (e) => {
            const allData = e.target.result;
            if (allData.length === 0) {
                showAlert("NENHUM √ÅUDIO PARA SALVAR");
                return;
            }
            
            const processed = allData.map(item => {
                if (item.type === 'settings') {
                    return {
                        type: 'settings',
                        page: item.page,
                        pad: item.pad,
                        volume: item.volume,
                        fadeIn: item.fadeIn,
                        fadeOut: item.fadeOut,
                        fadeIndex: item.fadeIndex,
                        loop: item.loop || false
                    };
                } else if (item.type === 'stopgroup') {
                    return {
                        type: 'stopgroup',
                        page: item.page,
                        pad: item.pad,
                        targets: item.targets
                    };
                } else {
                    const bytes = new Uint8Array(item.data);
                    let binary = '';
                    for (let i = 0; i < bytes.byteLength; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return {
                        uid: item.uid,
                        page: item.page,
                        id: item.id,
                        name: item.name,
                        data: btoa(binary)
                    };
                }
            });
            
            const jsonData = JSON.stringify(processed, null, 2);
            const blob = new Blob([jsonData], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `MasterConsole_Backup_${new Date().toISOString().slice(0,10)}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            const audioCount = allData.filter(d => d.type !== 'settings' && d.type !== 'stopgroup').length;
            showAlert(`BACKUP SALVO (${audioCount} √°udio(s))`);
        };
    }

    async function loadProject(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!MasterConsole.db) {
            showAlert("BANCO DE DADOS N√ÉO DISPON√çVEL");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                const tx = MasterConsole.db.transaction("pads", "readwrite");
                const store = tx.objectStore("pads");
                store.clear();
                
                for (let item of data) {
                    if (item.type === 'settings') {
                        store.put({
                            uid: `settings-${item.page}-${item.pad}`,
                            type: 'settings',
                            page: item.page,
                            pad: item.pad,
                            volume: item.volume,
                            fadeIn: item.fadeIn,
                            fadeOut: item.fadeOut,
                            fadeIndex: item.fadeIndex,
                            loop: item.loop || false
                        });
                    } else if (item.type === 'stopgroup') {
                        store.put({
                            uid: `stopgroup-${item.page}-${item.pad}`,
                            type: 'stopgroup',
                            page: item.page,
                            pad: item.pad,
                            targets: item.targets
                        });
                    } else {
                        const bin = Uint8Array.from(atob(item.data), c => c.charCodeAt(0)).buffer;
                        store.put({
                            uid: item.uid,
                            page: item.page,
                            id: item.id,
                            name: item.name,
                            data: bin
                        });
                    }
                }
                
                tx.oncomplete = () => {
                    showAlert("PROJETO RESTAURADO!");
                    MasterConsole.changePage('A');
                    MasterConsole.loadStopGroups();
                };
                
                e.target.value = '';
            } catch(err) {
                console.error("Erro ao carregar projeto:", err);
                showAlert("ARQUIVO DE BACKUP INV√ÅLIDO");
            }
        };
        reader.readAsText(file);
    }

    // ============================================
    // FUN√á√ïES DE INTERFACE
    // ============================================

    function clickInput(id) {
        document.getElementById(`in-${id}`).click();
    }
    
    function toggleMenu(e, id) {
        e.stopPropagation();
        document.querySelectorAll('.ctx-menu').forEach(m => {
            if (m.id !== `menu-${id}`) m.classList.remove('show');
        });
        document.getElementById(`menu-${id}`).classList.toggle('show');
    }

    // ============================================
    // STOP GROUPS MODAL
    // ============================================

    let currentEditingPad = null;
    
    function openStopGroupModal(padId) {
        currentEditingPad = padId;
        const key = `${MasterConsole.current.page}-${padId}`;
        
        document.getElementById('modalTitle').textContent = `STOP GROUP - PAD ${padId}`;
        document.getElementById('modalDesc').textContent = 
            `Selecione os pads que ser√£o PARADOS quando o Pad ${padId} tocar.`;
        
        const grid = document.getElementById('stopGroupGrid');
        grid.innerHTML = '';
        
        for (let i = 1; i <= 9; i++) {
            if (i === padId) continue;
            
            const checkId = `stop-check-${i}`;
            const targetKey = `${MasterConsole.current.page}-${i}`;
            const targets = MasterConsole.settings.stopGroups[key];
            const isChecked = targets ? targets.includes(targetKey) : false;
            
            const checkDiv = document.createElement('div');
            checkDiv.className = 'stop-group-check';
            checkDiv.innerHTML = `
                <input type="checkbox" id="${checkId}" ${isChecked ? 'checked' : ''}>
                <label for="${checkId}">Pad ${i}</label>
            `;
            grid.appendChild(checkDiv);
        }
        
        document.getElementById('stopGroupModal').classList.add('active');
        document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show'));
    }
    
    function closeStopGroupModal() {
        document.getElementById('stopGroupModal').classList.remove('active');
        currentEditingPad = null;
    }
    
    async function saveStopGroup() {
        if (!currentEditingPad || !MasterConsole.db) return;
        
        const key = `${MasterConsole.current.page}-${currentEditingPad}`;
        const targets = [];
        
        for (let i = 1; i <= 9; i++) {
            if (i === currentEditingPad) continue;
            const check = document.getElementById(`stop-check-${i}`);
            if (check && check.checked) {
                targets.push(`${MasterConsole.current.page}-${i}`);
            }
        }
        
        const tx = MasterConsole.db.transaction("pads", "readwrite");
        const store = tx.objectStore("pads");
        
        if (targets.length > 0) {
            await store.put({
                uid: `stopgroup-${key}`,
                type: 'stopgroup',
                page: MasterConsole.current.page,
                pad: currentEditingPad,
                targets: targets
            });
            MasterConsole.settings.stopGroups[key] = targets;
        } else {
            await store.delete(`stopgroup-${key}`);
            delete MasterConsole.settings.stopGroups[key];
        }
        
        tx.oncomplete = () => {
            MasterConsole.updateStopGroupMenuLabels();
            showAlert(`STOP GROUP PAD ${currentEditingPad}: ${targets.length || 'NENHUM'} alvo(s)`);
            closeStopGroupModal();
        };
    }

    // ============================================
    // VU METER
    // ============================================

    function updateVU() {
        if (!MasterConsole.audio.analyser) {
            requestAnimationFrame(updateVU);
            return;
        }
        
        const data = new Float32Array(MasterConsole.audio.analyser.frequencyBinCount);
        MasterConsole.audio.analyser.getFloatTimeDomainData(data);
        
        let sum = 0;
        for (let a of data) sum += a * a;
        let rms = Math.sqrt(sum / data.length);
        
        let level = 0;
        if (rms > 0) {
            level = Math.max(0, Math.min(100, (((20 * Math.log10(rms)) + 48) / 48) * 100));
        }
        
        document.getElementById('vu-fill').style.width = level + "%";
        requestAnimationFrame(updateVU);
    }

    // ============================================
    // INICIAR APLICA√á√ÉO
    // ============================================

    // Iniciar quando a p√°gina carregar
    window.addEventListener('DOMContentLoaded', () => {
        initApp();
        // Iniciar VU Meter
        updateVU();
    });

</script>
</body>
</html>

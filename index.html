<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Console - Helton Alves</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&display=swap');
        :root { --bg: #050505; --card: #111111; --pad-bg: #1a1a1a; --primary: #00e5ff; --accent: #00ff88; --danger: #ff4d4d; --text: #f0f0f0; --dim: #999999; }
        body.pg-A { --primary: #00e5ff; } body.pg-B { --primary: #ffcc00; } body.pg-C { --primary: #d600ff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { zoom: 1.25; background: var(--card); padding: 12px 25px; border-radius: 12px; width: 96vw; max-width: 1350px; border: 1px solid #333; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 0 50px #000; }
        .header-main { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 8px; }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 1.7rem; font-weight: 700; letter-spacing: 2px; color: #fff; text-transform: uppercase; }
        .brand span { color: var(--primary); }
        .icon-actions { display: flex; gap: 12px; }
        .action-wrapper { display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #222; border: 2px solid #444; border-radius: 8px; cursor: pointer; color: #fff; transition: 0.2s; }
        .icon-btn:hover { border-color: var(--primary); }
        .tooltip-text { font-size: 0.55rem; font-weight: 800; color: var(--dim); }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .page-tabs { display: flex; gap: 8px; }
        .tab { background: #1a1a1a; border: 2px solid #333; color: var(--dim); padding: 6px 20px; border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 0.8rem; }
        .tab.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .grid-pads { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pad { background: var(--pad-bg); height: 110px; border-radius: 10px; border: 2px solid #333; position: relative; cursor: pointer; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        .pad.active { border-color: var(--accent); background: #000; }
        .prog-bar { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: rgba(0, 255, 136, 0.1); border-right: 2px solid var(--accent); pointer-events: none; }
        .p-title { font-size: 1rem; font-weight: 800; color: var(--primary); text-align: center; margin-top: 20px; z-index: 2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pad-controls { position: absolute; top: 5px; right: 8px; display: flex; gap: 5px; z-index: 10; }
        .ctx-menu { position: absolute; top: 25px; right: 0; background: #222; border: 1px solid #444; border-radius: 4px; display: none; flex-direction: column; z-index: 1000; }
        .ctx-menu.show { display: flex; }
        .ctx-opt { padding: 10px 15px; font-size: 0.75rem; cursor: pointer; color: #fff; white-space: nowrap; border-bottom: 1px solid #333; }
        #alert { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 8px 20px; border-radius: 5px; font-weight: 800; display: none; z-index: 9999; }
        .master-strip { display: grid; grid-template-columns: 1fr 150px; gap: 15px; background: #000; padding: 8px 15px; border-radius: 6px; border: 1px solid #222; }
        #vu-fill { height: 8px; width: 0%; background: var(--accent); border-radius: 4px; transition: 0.1s; }
    </style>
</head>
<body class="pg-A">
<div id="alert"></div>
<div class="container">
    <div class="header-main">
        <div class="brand">MASTER<span>CONSOLE</span></div>
        <div class="icon-actions">
            <div class="action-wrapper"><div class="icon-btn" onclick="stopAll()">üõë</div><div class="tooltip-text">STOP</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="saveProject()">üíæ</div><div class="tooltip-text">SALVAR</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="document.getElementById('fileIn').click()">üìÇ</div><div class="tooltip-text">ABRIR</div></div>
            <div class="action-wrapper"><div class="icon-btn" onclick="confirmWipe()">üóëÔ∏è</div><div class="tooltip-text">RESET</div></div>
            <input type="file" id="fileIn" style="display:none" accept=".json" onchange="loadProject(event)">
        </div>
    </div>
    <div class="top-row">
        <div class="page-tabs">
            <div class="tab active" data-pg="A" onclick="changePage('A')">BANCO A</div>
            <div class="tab" data-pg="B" onclick="changePage('B')">BANCO B</div>
            <div class="tab" data-pg="C" onclick="changePage('C')">BANCO C</div>
        </div>
    </div>
    <div class="master-strip">
        <div style="display:flex; align-items:center;"><div id="vu-fill"></div></div>
        <input type="range" id="gainSlider" min="0" max="1.5" step="0.01" value="1.0">
    </div>
    <div class="grid-pads" id="padGrid"></div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    const analyser = audioCtx.createAnalyser();
    masterGain.connect(analyser); analyser.connect(audioCtx.destination);

    let sounds = {}; let activeSources = {}; let currentPage = 'A'; let db; let loops = {};

    const grid = document.getElementById('padGrid');
    for (let i = 1; i <= 9; i++) {
        const div = document.createElement('div');
        div.className = 'pad'; div.id = `pad-${i}`;
        div.innerHTML = `
            <div class="pad-controls">
                <span id="loop-icon-${i}" style="font-size:0.8rem; display:none;">üîÑ</span>
                <div style="cursor:pointer; color:#666;" onclick="toggleCtx(event, ${i})">‚ãÆ</div>
                <div class="ctx-menu" id="menu-${i}">
                    <div class="ctx-opt" onclick="document.getElementById('in-${i}').click()">üìÅ CARREGAR</div>
                    <div class="ctx-opt" onclick="toggleLoop(${i})">üîÑ LOOP ON/OFF</div>
                    <div class="ctx-opt" onclick="clearSlot(${i})">üóëÔ∏è LIMPAR</div>
                </div>
            </div>
            <div class="prog-bar" id="prog-${i}"></div>
            <div class="p-title" id="name-${i}">---</div>
            <input type="file" id="in-${i}" style="display:none" accept="audio/*" onchange="handleFile(event, ${i})">
        `;
        div.onclick = (e) => { if(!e.target.closest('.pad-controls') && !e.target.closest('.ctx-menu')) playSound(i); };
        grid.appendChild(div);
    }

    const dbReq = indexedDB.open("MasterConsoleDB", 9);
    dbReq.onupgradeneeded = (e) => { e.target.result.createObjectStore("pads", {keyPath: "uid"}); };
    dbReq.onsuccess = (e) => { db = e.target.result; changePage('A'); };

    function showAlert(t) { const a = document.getElementById('alert'); a.innerText = t; a.style.display = 'block'; setTimeout(()=>a.style.display='none', 2000); }

    async function changePage(p) {
        stopAll(); currentPage = p;
        document.body.className = `pg-${p}`;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.pg === p));
        for(let i=1; i<=9; i++) {
            document.getElementById(`name-${i}`).innerText = "---";
            document.getElementById(`prog-${i}`).style.width = "0%";
            document.getElementById(`loop-icon-${i}`).style.display = loops[currentPage+i] ? 'inline' : 'none';
        }
        sounds = {};
        const tx = db.transaction("pads", "readonly");
        tx.objectStore("pads").getAll().onsuccess = (e) => {
            e.target.result.filter(x => x.page === currentPage).forEach(async item => {
                const buffer = await audioCtx.decodeAudioData(item.data.slice(0));
                sounds[item.id] = { buffer, name: item.name, duration: buffer.duration, raw: item.data };
                document.getElementById(`name-${item.id}`).innerText = item.name;
            });
        };
    }

    async function handleFile(e, id) {
        const file = e.target.files[0]; if(!file) return;
        const fileName = file.name.split('.')[0];
        const raw = await file.arrayBuffer();
        const buffer = await audioCtx.decodeAudioData(raw.slice(0));
        sounds[id] = { buffer, name: fileName, duration: buffer.duration, raw: raw };
        const tx = db.transaction("pads", "readwrite");
        tx.objectStore("pads").put({ uid: currentPage+id, page: currentPage, id: id, name: fileName, data: raw });
        document.getElementById(`name-${id}`).innerText = fileName;
        showAlert("CARREGADO!");
    }

    function playSound(id) {
        if(!sounds[id]) return;
        if(activeSources[id]) { stopSound(id); return; }
        const src = audioCtx.createBufferSource();
        src.buffer = sounds[id].buffer; src.loop = !!loops[currentPage+id];
        src.connect(masterGain); src.start(0); activeSources[id] = src;
        document.getElementById(`pad-${id}`).classList.add('active');
        const anim = () => {
            if(!activeSources[id]) return;
            let elapsed = (audioCtx.currentTime % sounds[id].duration);
            document.getElementById(`prog-${id}`).style.width = (elapsed/sounds[id].duration*100) + "%";
            requestAnimationFrame(anim);
        }; anim();
        src.onended = () => stopSound(id);
    }

    function stopSound(id) { if(activeSources[id]) { try{activeSources[id].stop();}catch(e){} activeSources[id] = null; } document.getElementById(`pad-${id}`).classList.remove('active'); document.getElementById(`prog-${id}`).style.width = "0%"; }
    function stopAll() { Object.keys(activeSources).forEach(id => stopSound(id)); }

    function saveProject() {
        const tx = db.transaction("pads", "readonly");
        tx.objectStore("pads").getAll().onsuccess = (e) => {
            const data = e.target.result; if(!data.length) return showAlert("BANCO VAZIO!");
            const backup = data.map(item => {
                let binary = ''; const bytes = new Uint8Array(item.data);
                for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
                return { page: item.page, id: item.id, name: item.name, data: btoa(binary) };
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(backup)], {type: "application/json"}));
            a.download = "CONSOLE_BACKUP.json"; a.click();
            showAlert("SALVO!");
        };
    }

    function loadProject(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = JSON.parse(ev.target.result);
            const tx = db.transaction("pads", "readwrite");
            const store = tx.objectStore("pads"); store.clear();
            data.forEach(item => {
                const bin = Uint8Array.from(atob(item.data), c => c.charCodeAt(0)).buffer;
                store.put({ uid: item.page+item.id, page: item.page, id: item.id, name: item.name, data: bin });
            });
            tx.oncomplete = () => location.reload();
        }; reader.readAsText(file);
    }

    function toggleLoop(id) { loops[currentPage+id] = !loops[currentPage+id]; document.getElementById(`loop-icon-${id}`).style.display = loops[currentPage+id] ? 'inline' : 'none'; }
    function clearSlot(id) { const tx = db.transaction("pads", "readwrite"); tx.objectStore("pads").delete(currentPage+id); location.reload(); }
    function confirmWipe() { if(confirm("LIMPAR TUDO?")) { const tx = db.transaction("pads", "readwrite"); tx.objectStore("pads").clear(); location.reload(); } }
    function toggleCtx(e, id) { e.stopPropagation(); document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show')); document.getElementById(`menu-${id}`).classList.add('show'); }
    window.onclick = () => document.querySelectorAll('.ctx-menu').forEach(m => m.classList.remove('show'));
    document.getElementById('gainSlider').oninput = (e) => masterGain.gain.value = e.target.value;

    function updateVU() {
        const data = new Float32Array(analyser.frequencyBinCount); analyser.getFloatTimeDomainData(data);
        let sum = 0; for(let a of data) sum += a*a;
        let level = Math.sqrt(sum/data.length) * 200;
        document.getElementById('vu-fill').style.width = Math.min(100, level) + "%";
        requestAnimationFrame(updateVU);
    }
    updateVU();
</script>
</body>
</html>
